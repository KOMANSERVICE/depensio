name: üöÄ Deploy to PROD

on:
  workflow_dispatch:

jobs:
  deploy-prod:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v3

      - name: üöÄ Deploy to Prod
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USER_PROD }}
          key: ${{ secrets.SSH_PRIVATE_KEY_PROD }}
          passphrase: ${{ secrets.SSH_PASSPHRASE_PROD }}
          port: 22
          script: |      
            TARGET_DIR="/home/komanatse/depensio"
            mkdir -p $TARGET_DIR/deploy
            CURRENT_TAG="${GITHUB_REF#refs/tags/}"
            LAST_TAG_FILE="$TARGET_DIR/deploy/last_deployed_tag"

            # Si fichier n'existe pas encore, on le cr√©e avec une version tr√®s basse
            if [ ! -f "$LAST_TAG_FILE" ]; then
              echo "v0.0.0" > "$LAST_TAG_FILE"
            fi          
            
            LAST_DEPLOYED_TAG=$(cat "$LAST_TAG_FILE")
            CURRENT_TAG="${{ github.ref_name }}"
            
            echo "Dernier tag d√©ploy√© : $LAST_DEPLOYED_TAG"
            echo "Tag actuel : $CURRENT_TAG"
            
            # Comparer les versions (sup√©rieur uniquement)
            if [ "$(printf '%s\n' "$CURRENT_TAG" "$LAST_DEPLOYED_TAG" | sort -V | tail -n1)" != "$CURRENT_TAG" ]; then
              echo "‚ö†Ô∏è Ce tag est inf√©rieur au dernier d√©ploy√© : $LAST_DEPLOYED_TAG"
              exit 1
            fi
            
            echo "üöÄ Lancement du script de sauvegarde des volumes Docker"
            chmod +x /home/savevolume/backup_docker_volumes.sh
            /home/savevolume/backup_docker_volumes.sh
            
            echo "‚û°Ô∏è R√©cup√©rer le pojet sur github"            
            REPO_URL="https://laserda:${{ secrets.TOKEN }}@github.com/KOMANSERVICE/depensio.git"
            
            # V√©rifier si le dossier existe
            if [ -d "$TARGET_DIR" ]; then
              echo "üìÇ Le dossier $TARGET_DIR existe d√©j√†."
              if [ -d "$TARGET_DIR/.git" ]; then
                echo "‚úÖ D√©p√¥t Git trouv√©, tentative de mise √† jour..."
                cd "$TARGET_DIR"
                docker compose -f docker-compose.prod.yml down
                # reset + pull avec gestion d'erreur
                git reset --hard
                if ! git pull origin main; then
                  echo "‚ùå Pull √©chou√© (token peut-√™tre expir√©). Suppression et reclonage..."
                  cd ..
                  rm -rf "$TARGET_DIR"
                  git clone "$REPO_URL" "$TARGET_DIR"
                  cd "$TARGET_DIR"
                fi
              else
                echo "‚ö†Ô∏è Dossier existe mais n'est pas un d√©p√¥t Git ‚Üí suppression et clonage"
                rm -rf "$TARGET_DIR"
                git clone "$REPO_URL" "$TARGET_DIR"
                cd "$TARGET_DIR"
              fi
            else
              echo "‚¨áÔ∏è Clonage du d√©p√¥t..."
              git clone "$REPO_URL" "$TARGET_DIR"
              cd "$TARGET_DIR"
            fi
            
            echo "‚û°Ô∏è Cr√©er le dossier shared"
            mkdir -p /home/komanatse/depensio/vault/shared
            
            JSON_PATH="/home/komanatse/depensio/vault/shared/vault-depensio-env.json"            
            # ‚úÖ Cr√©ation du fichier s'il n'existe pas
            if [ ! -f "$JSON_PATH" ]; then
              echo "üìÑ Cr√©ation du fichier $JSON_PATH"
              touch "$JSON_PATH"
              chmod +x  "$JSON_PATH"
            fi            
            cat <<EOF > /home/komanatse/depensio/vault/shared/vault-depensio-env.json
            {
              "Vault__Uri": "${{ vars.VAULT_ADDR }}",
              "Vault__RoleId": "${{ secrets.ROLE_ID_PROD }}",
              "Vault__SecretId": "${{ secrets.SECRET_ID_PROD }}"
            }
            EOF

            ENV_PATH="/home/komanatse/depensio/.env"            
            # ‚úÖ Cr√©ation du fichier s'il n'existe pas
            if [ ! -f "$ENV_PATH" ]; then
              echo "üìÑ Cr√©ation du fichier $ENV_PATH"
              touch "$ENV_PATH"
              chmod +x  "$ENV_PATH"
            fi
            
            cat <<EOF > /home/komanatse/depensio/.env
            # Base de donn√©es PostgreSQL
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_PROD }}
            POSTGRES_DB=${{ vars.POSTGRES_DB_PROD }}
            POSTGRES_USER=${{ vars.POSTGRES_USER_PROD }}
            
            # Vault secret path
            VAULT_PATH=${{ vars.VAULT_PATH }}

            # depensio.api
            CONNECTION_STRING_API=${{ secrets.CONNECTION_STRING_API }}
            MAIL_CONFIG_ID=${{ vars.MAIL_CONFIG_ID_PROD }}
            MAIL_CONFIG_PASSWORD=${{ vars.MAIL_CONFIG_PASSWORD }}
            MAIL_CONFIG_NAME=${{ vars.MAIL_CONFIG_NAME }}
            MAIL_CONFIG_HOST=${{ vars.MAIL_CONFIG_HOST }}
            MAIL_CONFIG_PORT=${{ vars.MAIL_CONFIG_PORT }}
            JWT_VALID_AUDIENCE_API=${{ vars.JWT_VALID_AUDIENCE_API_PROD }}
            JWT_VALID_ISSUER_API=${{ vars.JWT_VALID_ISSUER_API_PROD }}
            JWT_SECRET_API=${{ secrets.JWT_SECRET_API }}           
            N8N_URI=${{ vars.N8N_URI }}
            EMAIL_SUPPORT=${{ vars.EMAIL_SUPPORT_PROD }}
            WEBHOOKID=${{ secrets.WEBHOOKID_PROD }}      
            VAULT_URI=${{ vars.VAULT_ADDR }}
            VAULT_ROLE_ID=${{ secrets.ROLE_ID_PROD }}
            VAULT_SECRET_ID=${{ secrets.SECRET_ID_PROD }}
            VAULT_PATH_MOUNT_POINT=${{ secrets.VAULT_PATH_MOUNT_POINT }}
            VAULT_MOUNT_POINT=${{ secrets.VAULT_MOUNT_POINT }}
            
            # depensio.web
            API_SETTINGS_URL=${{ vars.API_SETTINGS_URL_PROD }}
            JWT_VALID_AUDIENCE_WEB=${{ vars.JWT_VALID_AUDIENCE_WEB }}
            JWT_VALID_ISSUER_WEB=${{ vars.JWT_VALID_ISSUER_WEB }}
            JWT_SECRET_WEB=${{ secrets.JWT_SECRET_WEB }}
            EOF

            chmod 644 /home/komanatse/depensio/.env

            
            cat <<EOF > /home/komanatse/depensio/frontend/depensio.Web.Client/wwwroot/appsettings.json
            {
              "Logging": {
                "LogLevel": {
                  "Default": "Information",
                  "Microsoft.AspNetCore": "Warning"
                }
              },
              "AllowedHosts": "*",
              "ApiSettings": {
                "Uri": "${{ vars.API_SETTINGS_URL_PROD }}"
              }
            }
            EOF
            
            cat <<EOF > /home/komanatse/depensio/frontend/depensio.Web/appsettings.json
            {
              "Logging": {
                "LogLevel": {
                  "Default": "Information",
                  "Microsoft.AspNetCore": "Warning"
                }
              },
              "AllowedHosts": "*",
              "ApiSettings": {
                "Uri": "${{ vars.API_SETTINGS_URL_PROD }}"
              }
            }
            EOF
            
            echo "‚û°Ô∏è Passage au dossier projet"
            cd /home/komanatse/depensio
            echo "üì¶ Pull du nouveau contenu"
            git pull origin main
            echo "‚ôªÔ∏è Rebuild & redeploy"
            docker compose -f docker-compose.prod.yml down
            docker compose -f docker-compose.prod.yml  --env-file .env up -d --build

            # Sauvegarde du tag actuel pour √©viter redeploiement
            echo "$CURRENT_TAG" > "$LAST_TAG_FILE"
            echo "‚úÖ Tag $CURRENT_TAG marqu√© comme d√©ploy√©."
