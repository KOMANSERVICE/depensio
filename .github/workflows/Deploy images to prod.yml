name: Deploy images to prod

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]  # workflow DEV
    types:
      - completed  # se dÃ©clenche aprÃ¨s la fin du workflow DEV

env:
  DEPLOY_PATH: /home/komanatse/depensio

jobs:
  deploy:
    if: >
      github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'success' &&
      startsWith(github.event.workflow_run.head_branch, 'v')
    name: Deploy to VPS PROD (auto-tag)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4


      - name: Copy docker-compose and .env to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USER_PROD }}
          key: ${{ secrets.SSH_PRIVATE_KEY_PROD }}
          passphrase: ${{ secrets.SSH_PASSPHRASE_PROD }}
          port: 22
          source: "docker-compose.prod.yml"
          target: ${{ env.DEPLOY_PATH }}

      - name: SSH to VPS and deploy stack
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USER_PROD }}
          key: ${{ secrets.SSH_PRIVATE_KEY_PROD }}
          passphrase: ${{ secrets.SSH_PASSPHRASE_PROD }}
          port: 22
          script: |
            TAG="latest"
            DIR_PATH="${{ env.DEPLOY_PATH }}"

            echo "ðŸ“¦ DÃ©ploiement avec le tag Docker : ${TAG}"

            cd $DIR_PATH

            echo "ðŸ›‘ ArrÃªt des anciens conteneurs"
            docker compose -f docker-compose.prod.yml down

            echo "ðŸš€ Sauvegarde des volumes Docker"
            chmod +x /home/komanatse/savevolume/backup_docker_volumes.sh
            /home/komanatse/savevolume/backup_docker_volumes.sh

            ENV_PATH="$DIR_PATH/.env"
            if [ -f "$ENV_PATH" ]; then
              TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
              mv "$ENV_PATH" "${ENV_PATH}_${TIMESTAMP}.bak"
              echo "ðŸŒ€ Fichier .env renommÃ© : ${ENV_PATH}_${TIMESTAMP}.bak"
            fi

            cat <<EOF > $ENV_PATH
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_PROD }}
            POSTGRES_DB=${{ vars.POSTGRES_DB_PROD }}
            POSTGRES_USER=${{ vars.POSTGRES_USER_PROD  }}
            VAULT_PATH=${{ vars.VAULT_PATH }}
            VAULT_URI=${{ vars.VAULT_ADDR }}
            VAULT_ROLE_ID=${{ secrets.ROLE_ID_PROD }}
            VAULT_SECRET_ID=${{ secrets.SECRET_ID_PROD }}
            VAULT_PATH_MOUNT_POINT=${{ secrets.VAULT_PATH_MOUNT_POINT }}
            VAULT_MOUNT_POINT=${{ secrets.VAULT_MOUNT_POINT }}
            CONNECTION_STRING_API=${{ secrets.CONNECTION_STRING_API }}
            MAIL_CONFIG_ID=${{ vars.MAIL_CONFIG_ID_PROD }}
            MAIL_CONFIG_PASSWORD=${{ vars.MAIL_CONFIG_PASSWORD }}
            MAIL_CONFIG_NAME=${{ vars.MAIL_CONFIG_NAME }}
            MAIL_CONFIG_HOST=${{ vars.MAIL_CONFIG_HOST }}
            MAIL_CONFIG_PORT=${{ vars.MAIL_CONFIG_PORT }}
            JWT_VALID_AUDIENCE_API=${{ vars.JWT_VALID_AUDIENCE_API_PROD }}
            JWT_VALID_ISSUER_API=${{ vars.JWT_VALID_ISSUER_API_PROD  }}
            JWT_SECRET_API=${{ secrets.JWT_SECRET_API }}
            N8N_URI=${{ vars.N8N_URI }}
            EMAIL_SUPPORT=${{ vars.EMAIL_SUPPORT_PROD }}
            WEBHOOKID=${{ secrets.WEBHOOKID_PROD }}
            CORS_ALLOWED_ORIGINS=${{ secrets.CORS_ALLOWED_ORIGINS }}
            API_SETTINGS_URL=${{ vars.API_SETTINGS_URL_PROD }}
            JWT_VALID_AUDIENCE_WEB=${{ vars.JWT_VALID_AUDIENCE_WEB }}
            JWT_VALID_ISSUER_WEB=${{ vars.JWT_VALID_ISSUER_WEB }}
            JWT_SECRET_WEB=${{ secrets.JWT_SECRET_WEB }}
            SERVICE_MENU_URI=${{ secrets.SERVICE_MENU_URI }}
            DOCKER_TAG=$TAG
            LOCALDOMAIN=${{ vars.LOCALDOMAIN }}
            SERVICE_MAGASIN_URI=${{ secrets.SERVICE_MAGASIN_URI }}
            EOF

            chmod 644 $ENV_PATH
            dos2unix $ENV_PATH

            
            mkdir -p $DIR_PATH/frontend/depensio.Web.Client/wwwroot
            mkdir -p $DIR_PATH/frontend/depensio.Web
            
            cat <<EOF > $DIR_PATH/frontend/depensio.Web.Client/wwwroot/appsettings.json
            {
              "Logging": {
                "LogLevel": {
                  "Default": "Information",
                  "Microsoft.AspNetCore": "Warning"
                }
              },
              "AllowedHosts": "*",
              "ApiSettings": {
                "Uri": "${{ vars.API_SETTINGS_URL_PROD  }}"
              }
            }
            EOF
            
            cat <<EOF > $DIR_PATH/frontend/depensio.Web/appsettings.json
            {
              "Logging": {
                "LogLevel": {
                  "Default": "Information",
                  "Microsoft.AspNetCore": "Warning"
                }
              },
              "AllowedHosts": "*",
              "ApiSettings": {
                "Uri": "${{ vars.API_SETTINGS_URL_PROD  }}"
              }
            }
            EOF
            
            echo "ðŸ“¦ Pull des images version ${TAG}"
            docker compose -f docker-compose.prod.yml pull

            echo "ðŸš€ DÃ©marrage du stack avec le tag ${TAG}"
            DOCKER_TAG=$TAG docker compose -f docker-compose.prod.yml --env-file .env up -d --build --remove-orphans

            echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s (tag=${TAG})"
