name: Deploy images to dev

on:
  workflow_dispatch:

env:
  REGISTRY: ghcr.io/komanservice

jobs:
  deploy:
      name: Deploy to VPS
      runs-on: ubuntu-latest
  
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
          
        - name: Copy docker-compose and .env to VPS
          uses: appleboy/scp-action@v0.1.7
          with:
            host: ${{ secrets.SSH_HOST }}
            username: ${{ secrets.SSH_USER }}
            key: ${{ secrets.SSH_PRIVATE_KEY }}
            passphrase: ${{ secrets.SSH_PASSPHRASE }}
            port: 22
            source: "docker-compose.prod.yml"
            target: "/home/komanatse/depensio"
  
        - name: SSH to VPS and deploy stack
          uses: appleboy/ssh-action@v1.0.3
          with:
            host: ${{ secrets.SSH_HOST }}
            username: ${{ secrets.SSH_USER }}
            key: ${{ secrets.SSH_PRIVATE_KEY }}
            passphrase: ${{ secrets.SSH_PASSPHRASE }}
            port: 22
            script: |
              DIR_PATH="/home/komanatse/depensio"
              cd $DIR_PATH
              
              echo "ðŸ›‘ ArrÃªt des anciens conteneurs"
              docker compose -f docker-compose.prod.yml down
  
              ENV_PATH="$DIR_PATH/.env"    

              # âœ… Si le fichier existe dÃ©jÃ , on le renomme avec un timestamp
              if [ -f "$ENV_PATH" ]; then
                TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
                mv "$ENV_PATH" "${ENV_PATH}_${TIMESTAMP}.bak"
                echo "ðŸŒ€ Fichier .env existant renommÃ© en ${ENV_PATH}_${TIMESTAMP}.bak"
              fi

              # âœ… CrÃ©ation du fichier s'il n'existe pas
              if [ ! -f "$ENV_PATH" ]; then
                echo "ðŸ“„ CrÃ©ation du fichier $ENV_PATH"
                touch "$ENV_PATH"
                chmod +x  "$ENV_PATH"
              fi

              
              
              cat <<EOF > $DIR_PATH/.env
              # Base de donnÃ©es PostgreSQL
              POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
              POSTGRES_DB=${{ vars.POSTGRES_DB }}
              POSTGRES_USER=${{ vars.POSTGRES_USER }}
              
              # Vault secret path
              VAULT_PATH=${{ vars.VAULT_PATH }}
              VAULT_URI=${{ vars.VAULT_ADDR }}
              VAULT_ROLE_ID=${{ secrets.ROLE_ID }}
              VAULT_SECRET_ID=${{ secrets.SECRET_ID }}
              VAULT_PATH_MOUNT_POINT=${{ secrets.VAULT_PATH_MOUNT_POINT }}
              VAULT_MOUNT_POINT=${{ secrets.VAULT_MOUNT_POINT }}
  
              # depensio.api
              CONNECTION_STRING_API=${{ secrets.CONNECTION_STRING_API }}
              MAIL_CONFIG_ID=${{ vars.MAIL_CONFIG_ID }}
              MAIL_CONFIG_PASSWORD=${{ vars.MAIL_CONFIG_PASSWORD }}
              MAIL_CONFIG_NAME=${{ vars.MAIL_CONFIG_NAME }}
              MAIL_CONFIG_HOST=${{ vars.MAIL_CONFIG_HOST }}
              MAIL_CONFIG_PORT=${{ vars.MAIL_CONFIG_PORT }}
              JWT_VALID_AUDIENCE_API=${{ vars.JWT_VALID_AUDIENCE_API }}
              JWT_VALID_ISSUER_API=${{ vars.JWT_VALID_ISSUER_API }}
              JWT_SECRET_API=${{ secrets.JWT_SECRET_API }}            
              N8N_URI=${{ vars.N8N_URI }}
              EMAIL_SUPPORT=${{ vars.EMAIL_SUPPORT }}
              WEBHOOKID=${{ secrets.WEBHOOKID }}  
              CORS_ALLOWED_ORIGINS=${{ secrets.CORS_ALLOWED_ORIGINS }}   
              
              # depensio.web
              API_SETTINGS_URL=${{ vars.API_SETTINGS_URL }}
              JWT_VALID_AUDIENCE_WEB=${{ vars.JWT_VALID_AUDIENCE_WEB }}
              JWT_VALID_ISSUER_WEB=${{ vars.JWT_VALID_ISSUER_WEB }}
              JWT_SECRET_WEB=${{ secrets.JWT_SECRET_WEB }}
              EOF
  
              chmod 644 $DIR_PATH/.env
              dos2unix $DIR_PATH/.env
              
              # ðŸ”‘ Login Docker pour GHCR
              # echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
              
              echo "ðŸ“¦ Pull des nouvelles images"
              docker compose pull
  
              echo "ðŸš€ DÃ©marrage du stack"
              docker compose -f docker-compose.prod.yml  --env-file .env up -d --build --remove-orphans
  
              echo "âœ… Stack redÃ©ployÃ©e avec succÃ¨s !"
