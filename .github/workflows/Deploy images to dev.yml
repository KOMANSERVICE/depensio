name: Deploy images to dev

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Build and Push Docker Images"]  # nom exact du workflow prÃ©cÃ©dent
    types:
      - completed  # se dÃ©clenche quand le workflow prÃ©cÃ©dent est terminÃ©

env:
  DEPLOY_PATH: /home/komanatse/depensio

jobs:
  deploy:
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    name: Deploy to DEV VPS (auto-tag)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # DÃ©terminer le tag Docker Ã  dÃ©ployer
      - name: Define image tag
        id: vars
        run: |
          set -e

          BRANCH="${{ github.event.workflow_run.head_branch }}"
          REF="${{ github.event.workflow_run.head_sha }}"

          echo "ðŸ” Workflow build triggered on branch/tag: $BRANCH"

          # Si c'est un tag versionnÃ© (vX.X.X)
          if [[ "$BRANCH" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "env=prod" >> $GITHUB_OUTPUT
            echo "tag=$BRANCH" >> $GITHUB_OUTPUT
            echo "âœ… DÃ©ploiement PROD : $BRANCH"
          else
            echo "env=nonprod" >> $GITHUB_OUTPUT
            echo "ðŸ§ª DÃ©ploiement de la derniÃ¨re version non-prod"

            # RÃ©cupÃ©rer le dernier tag 'dev-' pushÃ© sur GHCR pour l'image API
            IMAGE_NAME="depensioapi"
            GH_API="https://hub.docker.com/v2/repositories/komanatse/${IMAGE_NAME}/tags?page_size=100"

            echo "ðŸ” Recherche du dernier tag 'dev-' pour ${IMAGE_NAME} sur GHCR..."
            TAG=$(curl -s  $GH_API | jq -r '.results[].name' | grep '^dev-' | sort -r | head -n 1)

            if [ -z "$TAG" ]; then
              echo "âŒ Aucun tag 'dev-' trouvÃ© sur GHCR. Abandon."
              exit 1
            fi

            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "âœ… Dernier tag dev trouvÃ© : $TAG"
          fi

      - name: Copy docker-compose and .env to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 22
          source: "docker-compose.prod.yml"
          target: ${{ env.DEPLOY_PATH }}

      - name: SSH to VPS and deploy stack
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 22
          script: |
            TAG="${{ steps.vars.outputs.tag }}"
            DIR_PATH="${{ env.DEPLOY_PATH }}"

            echo "ðŸ“¦ DÃ©ploiement avec le tag Docker : ${TAG}"

            cd $DIR_PATH

            echo "ðŸ›‘ ArrÃªt des anciens conteneurs"
            docker compose -f docker-compose.prod.yml down

            echo "ðŸš€ Sauvegarde des volumes Docker"
            chmod +x /home/komanatse/savevolume/backup_docker_volumes.sh
            /home/komanatse/savevolume/backup_docker_volumes.sh

            ENV_PATH="$DIR_PATH/.env"
            if [ -f "$ENV_PATH" ]; then
              TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
              mv "$ENV_PATH" "${ENV_PATH}_${TIMESTAMP}.bak"
              echo "ðŸŒ€ Fichier .env renommÃ© : ${ENV_PATH}_${TIMESTAMP}.bak"
            fi

            cat <<EOF > $ENV_PATH
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            POSTGRES_DB=${{ vars.POSTGRES_DB }}
            POSTGRES_USER=${{ vars.POSTGRES_USER }}
            VAULT_PATH=${{ vars.VAULT_PATH }}
            VAULT_URI=${{ vars.VAULT_ADDR }}
            VAULT_ROLE_ID=${{ secrets.ROLE_ID }}
            VAULT_SECRET_ID=${{ secrets.SECRET_ID }}
            VAULT_PATH_MOUNT_POINT=${{ secrets.VAULT_PATH_MOUNT_POINT }}
            VAULT_MOUNT_POINT=${{ secrets.VAULT_MOUNT_POINT }}
            CONNECTION_STRING_API=${{ secrets.CONNECTION_STRING_API }}
            MAIL_CONFIG_ID=${{ vars.MAIL_CONFIG_ID }}
            MAIL_CONFIG_PASSWORD=${{ vars.MAIL_CONFIG_PASSWORD }}
            MAIL_CONFIG_NAME=${{ vars.MAIL_CONFIG_NAME }}
            MAIL_CONFIG_HOST=${{ vars.MAIL_CONFIG_HOST }}
            MAIL_CONFIG_PORT=${{ vars.MAIL_CONFIG_PORT }}
            JWT_VALID_AUDIENCE_API=${{ vars.JWT_VALID_AUDIENCE_API }}
            JWT_VALID_ISSUER_API=${{ vars.JWT_VALID_ISSUER_API }}
            JWT_SECRET_API=${{ secrets.JWT_SECRET_API }}
            N8N_URI=${{ vars.N8N_URI }}
            EMAIL_SUPPORT=${{ vars.EMAIL_SUPPORT }}
            WEBHOOKID=${{ secrets.WEBHOOKID }}
            CORS_ALLOWED_ORIGINS=${{ secrets.CORS_ALLOWED_ORIGINS }}
            API_SETTINGS_URL=${{ vars.API_SETTINGS_URL }}
            JWT_VALID_AUDIENCE_WEB=${{ vars.JWT_VALID_AUDIENCE_WEB }}
            JWT_VALID_ISSUER_WEB=${{ vars.JWT_VALID_ISSUER_WEB }}
            JWT_SECRET_WEB=${{ secrets.JWT_SECRET_WEB }}
            DOCKER_TAG=$TAG
            EOF

            chmod 644 $ENV_PATH
            dos2unix $ENV_PATH

            echo "ðŸ”‘ Login GHCR"
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            echo "ðŸ“¦ Pull des images version ${TAG}"
            docker compose -f docker-compose.prod.yml pull

            echo "ðŸš€ DÃ©marrage du stack avec le tag ${TAG}"
            DOCKER_TAG=$TAG docker compose -f docker-compose.prod.yml --env-file .env up -d --build --remove-orphans

            echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s (tag=${TAG})"
