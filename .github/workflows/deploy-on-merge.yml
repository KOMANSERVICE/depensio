name: üöÄ Deploy DEV on Main PR Merge

on:
  workflow_dispatch:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  deploy-dev:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v3

      - name: üöÄ Deploy to Production Server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 22
          script: |           
            echo "‚û°Ô∏è R√©cup√©rer le pojet sur github"            
            REPO_URL="https://laserda:${{ secrets.TOKEN }}@github.com/KOMANSERVICE/depensio.git"
            TARGET_DIR="/home/komanatse/depensio"
            # V√©rifier si le dossier existe
            if [ -d "$TARGET_DIR" ]; then
              echo "üìÇ Le dossier $TARGET_DIR existe d√©j√†."
              if [ -d "$TARGET_DIR/.git" ]; then
                echo "‚úÖ D√©p√¥t Git trouv√©, tentative de mise √† jour..."
                cd "$TARGET_DIR"
                
                # reset + pull avec gestion d'erreur
                git reset --hard
                if ! git pull origin main; then
                  echo "‚ùå Pull √©chou√© (token peut-√™tre expir√©). Suppression et reclonage..."
                  docker compose -f docker-compose.prod.yml down
                  cd ..
                  rm -rf "$TARGET_DIR"
                  git clone "$REPO_URL" "$TARGET_DIR"
                  cd "$TARGET_DIR"
                fi
              else
                echo "‚ö†Ô∏è Dossier existe mais n'est pas un d√©p√¥t Git ‚Üí suppression et clonage"
                rm -rf "$TARGET_DIR"
                git clone "$REPO_URL" "$TARGET_DIR"
                cd "$TARGET_DIR"
              fi
            else
              echo "‚¨áÔ∏è Clonage du d√©p√¥t..."
              git clone "$REPO_URL" "$TARGET_DIR"
              cd "$TARGET_DIR"
            fi
            
            echo "‚û°Ô∏è Copier le fichier setup.deploy.sh"
            cp /home/komanatse/vaultdepensio/setup.deploy.sh /home/komanatse/depensio/vault/policies
            chmod +x /home/komanatse/depensio/vault/policies/setup.deploy.sh
            echo "‚û°Ô∏è Cr√©er le dossier shared"
            mkdir -p /home/komanatse/depensio/vault/shared
            
            JSON_PATH="/home/komanatse/depensio/vault/shared/vault-depensio-env.json"            
            # ‚úÖ Cr√©ation du fichier s'il n'existe pas
            if [ ! -f "$JSON_PATH" ]; then
              echo "üìÑ Cr√©ation du fichier $JSON_PATH"
              touch "$JSON_PATH"
              chmod +x  "$JSON_PATH"
            fi            
            cat <<EOF > /home/komanatse/depensio/vault/shared/vault-depensio-env.json
            {
              "Vault__Uri": "${{ vars.VAULT_ADDR }}",
              "Vault__RoleId": "${{ secrets.ROLE_ID }}",
              "Vault__SecretId": "${{ secrets.SECRET_ID }}"
            }
            EOF

            ENV_PATH="/home/komanatse/depensio/.env"            
            # ‚úÖ Cr√©ation du fichier s'il n'existe pas
            if [ ! -f "$ENV_PATH" ]; then
              echo "üìÑ Cr√©ation du fichier $ENV_PATH"
              touch "$ENV_PATH"
              chmod +x  "$ENV_PATH"
            fi
            
            cat <<EOF > /home/komanatse/depensio/.env
            # Base de donn√©es PostgreSQL
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            POSTGRES_DB=${{ vars.POSTGRES_DB }}
            POSTGRES_USER=${{ vars.POSTGRES_USER }}
            
            # Vault secret path
            VAULT_PATH=${{ vars.VAULT_PATH }}

            # depensio.api
            CONNECTION_STRING_API=${{ secrets.CONNECTION_STRING_API }}
            MAIL_CONFIG_ID=${{ vars.MAIL_CONFIG_ID }}
            MAIL_CONFIG_PASSWORD=${{ vars.MAIL_CONFIG_PASSWORD }}
            MAIL_CONFIG_NAME=${{ vars.MAIL_CONFIG_NAME }}
            MAIL_CONFIG_HOST=${{ vars.MAIL_CONFIG_HOST }}
            MAIL_CONFIG_PORT=${{ vars.MAIL_CONFIG_PORT }}
            JWT_VALID_AUDIENCE_API=${{ vars.JWT_VALID_AUDIENCE_API }}
            JWT_VALID_ISSUER_API=${{ vars.JWT_VALID_ISSUER_API }}
            JWT_SECRET_API=${{ secrets.JWT_SECRET_API }}
            
            # depensio.web
            API_SETTINGS_URL=${{ vars.API_SETTINGS_URL }}
            JWT_VALID_AUDIENCE_WEB=${{ vars.JWT_VALID_AUDIENCE_WEB }}
            JWT_VALID_ISSUER_WEB=${{ vars.JWT_VALID_ISSUER_WEB }}
            JWT_SECRET_WEB=${{ secrets.JWT_SECRET_WEB }}
            EOF

            chmod 644 /home/komanatse/depensio/.env
            dos2unix /home/komanatse/depensio/.env
            
            echo "‚û°Ô∏è Passage au dossier projet"
            cd /home/komanatse/depensio
            echo "üì¶ Pull du nouveau contenu"
            git pull origin main
            echo "‚ôªÔ∏è Rebuild & redeploy"
            docker compose -f docker-compose.prod.yml down
            docker compose -f docker-compose.prod.yml  --env-file .env up -d --build
