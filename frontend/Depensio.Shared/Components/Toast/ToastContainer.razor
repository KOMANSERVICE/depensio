@using depensio.Shared.Components.Toast
@inject ToastService ToastService

<div class="fixed top-4 right-4 space-y-3 z-50 w-96">
    @foreach (var toast in _toasts)
    {
        <div class="toast bg-white rounded shadow-lg p-4 flex items-start relative overflow-hidden border-l-4 @GetBorderColor(toast.Type)
                        @(toast.IsClosing ? "toast-exit toast-exit-active" : "toast-exit")">
            <div class="mr-3 text-xl">@((MarkupString)GetIcon(toast.Type))</div>
            <div class="flex-1">
                <p class="font-medium text-gray-800">@toast.Title</p>
                <p class="text-sm text-gray-600">@toast.Content</p>
            </div>
            <button class="ml-2 text-gray-400 hover:text-gray-600" @onclick="() => CloseToast(toast)">
                <i class="fas fa-times"></i>
            </button>

            <!-- Barre de progression -->
            <div class="absolute bottom-0 left-0 h-1 bg-gray-200 w-full">
                <div class="h-full primary-bg transition-all duration-100 linear @GetBorderColorProgress(toast.Type)"
                     style="width:@toast.Progress">
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<ToastMessage> _toasts = new();

    protected override void OnInitialized()
    {
        ToastService.OnShow += AddToast;
    }

    private void AddToast(ToastMessage toast)
    {
        toast.Progress = "100%";
        _toasts.Add(toast);
        StateHasChanged();

        // Animation de la barre
        _ = Task.Run(async () =>
        {
            int steps = 50;
            int delay = toast.Duration / steps;

            for (int i = steps; i >= 0; i--)
            {
                toast.Progress = $"{(i * 100) / steps}%";
                await InvokeAsync(StateHasChanged);
                await Task.Delay(delay);
            }

            await InvokeAsync(() => CloseToast(toast));
        });
    }

    private async Task CloseToast(ToastMessage toast)
    {
        if (_toasts.Contains(toast))
        {
            toast.IsClosing = true;
            StateHasChanged();

            // attendre la durée de l'animation CSS (0.5s)
            await Task.Delay(1000);

            _toasts.Remove(toast);
            StateHasChanged();
        }
    }

    private string GetIcon(string type) => type switch
    {
        "success" => "<i class='fas fa-check-circle text-green-500'></i>",
        "error" => "<i class='fas fa-times-circle text-red-500'></i>",
        "warning" => "<i class='fas fa-exclamation-triangle text-yellow-500'></i>",
        _ => "<i class='fas fa-info-circle text-blue-500'></i>"
    };

    private string GetBorderColor(string type) => type switch
    {
        "success" => "border-green-500",
        "error" => "border-red-500",
        "warning" => "border-yellow-500",
        _ => "border-blue-500"
    };

    private string GetBorderColorProgress(string type) => type switch
    {
        "success" => "bg-green-300",
        "error" => "bg-red-300",
        "warning" => "bg-yellow-300",
        _ => "bg-blue-300"
    };
}


@* <div class="fixed top-4 right-4 space-y-3 z-50 w-96">
    @foreach (var toast in _toasts)
    {
        <div class="toast @toast.Class bg-white rounded shadow-lg p-4 flex items-start relative overflow-hidden border-l-4 @GetBorderColor(toast.Type)">
            <div class="mr-3 text-xl">@((MarkupString)GetIcon(toast.Type))</div>
            <div class="flex-1">
                <p class="font-medium text-gray-800">@toast.Title</p>
                <p class="text-sm text-gray-600">@toast.Content</p>
            </div>
            <button class="ml-2 text-gray-400 hover:text-gray-600" @onclick="() => CloseToast(toast)">
                <i class="fas fa-times"></i>
            </button>

            <!-- Barre de progression -->
            <div class="absolute bottom-0 left-0 h-1 bg-gray-200 w-full">
                <div class="h-full transition-all duration-100 linear @GetBorderColorProgress(toast.Type) "
                     style="width:@toast.Progress">
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<ToastMessage> _toasts = new();

    protected override void OnInitialized()
    {
        ToastService.OnShow += AddToast;
    }

    private void AddToast(ToastMessage toast)
    {
        toast.Progress = "100%";
        _toasts.Add(toast);
        StateHasChanged();

        // Démarre la réduction de la barre
        _ = Task.Run(async () =>
        {
            int steps = 50;
            int delay = toast.Duration / steps;

            for (int i = steps; i >= 0; i--)
            {
                toast.Progress = $"{(i * 100) / steps}%";
                await InvokeAsync(StateHasChanged);
                await Task.Delay(delay);
            }
            toast.Class = "hide";
            await Task.Delay(1000);
            CloseToast(toast);
        });
    }

    private void CloseToast(ToastMessage toast)
    {
        if (_toasts.Contains(toast))
        {
            _toasts.Remove(toast);
            InvokeAsync(StateHasChanged);
        }
    }

    private string GetIcon(string type) => type switch
    {
        "success" => "<i class='fas fa-check-circle text-green-500'></i>",
        "error" => "<i class='fas fa-times-circle text-red-500'></i>",
        "warning" => "<i class='fas fa-exclamation-triangle text-yellow-500'></i>",
        _ => "<i class='fas fa-info-circle text-blue-500'></i>"
    };

    private string GetBorderColor(string type) => type switch
    {
        "success" => "border-green-500",
        "error" => "border-red-500",
        "warning" => "border-yellow-500",
        _ => "border-blue-500"
    };

    private string GetBorderColorProgress(string type) => type switch
    {
        "success" => "bg-green-300",
        "error" => "bg-red-300",
        "warning" => "bg-yellow-300",
        _ => "bg-blue-300"
    };
} *@
