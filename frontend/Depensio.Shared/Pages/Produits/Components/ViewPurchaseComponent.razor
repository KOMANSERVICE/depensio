@using depensio.Shared.Pages.Produits.Models
@inject IPurchaseService _purchaseService

<div class="p-6">
    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
        <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
                <span class="text-gray-500 dark:text-gray-400">Titre:</span>
                <span class="font-medium text-gray-900 dark:text-white ml-1">@Purchase.Title</span>
            </div>
            <div>
                <span class="text-gray-500 dark:text-gray-400">Fournisseur:</span>
                <span class="font-medium text-gray-900 dark:text-white ml-1">@Purchase.SupplierName</span>
            </div>
            <div>
                <span class="text-gray-500 dark:text-gray-400">Date d'achat:</span>
                <span class="font-medium text-gray-900 dark:text-white ml-1">
                    @if (Purchase.DateAchat != DateOnly.MinValue)
                    {
                        @Purchase.DateAchat.ToString("dd/MM/yyyy")
                    }
                    else
                    {
                        <span>--/--/----</span>
                    }
                </span>
            </div>
            <div>
                <span class="text-gray-500 dark:text-gray-400">Total:</span>
                <span class="font-semibold text-primary-700 ml-1">@Purchase.TotalAmount.ToString("N0") FCFA</span>
            </div>
            @if (!string.IsNullOrWhiteSpace(Purchase.Description))
            {
                <div class="col-span-2">
                    <span class="text-gray-500 dark:text-gray-400">Description:</span>
                    <p class="font-medium text-gray-900 dark:text-white mt-1">@Purchase.Description</p>
                </div>
            }
        </div>
    </div>

    <div class="mb-4">
        <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-2">Articles achetes</h4>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
            <thead class="bg-gray-100 dark:bg-gray-700">
                <tr>
                    <th scope="col" class="p-3 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400">
                        Produit
                    </th>
                    <th scope="col" class="p-3 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400">
                        Prix unitaire
                    </th>
                    <th scope="col" class="p-3 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400">
                        Quantite
                    </th>
                    <th scope="col" class="p-3 text-xs font-medium text-right text-gray-500 uppercase dark:text-gray-400">
                        Sous-total
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                @if (Purchase.Items.Any())
                {
                    @foreach (var item in Purchase.Items)
                    {
                        var productName = Products.FirstOrDefault(p => p.Id == item.ProductId)?.Name ?? "Produit inconnu";
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                            <td class="p-3 text-sm font-medium text-gray-900 dark:text-white">
                                @productName
                            </td>
                            <td class="p-3 text-sm text-gray-500 dark:text-gray-400">
                                @item.Price.ToString("N0") FCFA
                            </td>
                            <td class="p-3 text-sm text-gray-500 dark:text-gray-400">
                                @item.Quantity
                            </td>
                            <td class="p-3 text-sm font-medium text-gray-900 dark:text-white text-right">
                                @((item.Price * item.Quantity).ToString("N0")) FCFA
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="4" class="p-4 text-center text-gray-500 dark:text-gray-400">
                            Aucun article dans cet achat
                        </td>
                    </tr>
                }
            </tbody>
            @if (Purchase.Items.Any())
            {
                <tfoot class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <td colspan="2" class="p-3 text-sm font-semibold text-gray-900 dark:text-white">
                            Total
                        </td>
                        <td class="p-3 text-sm font-semibold text-gray-900 dark:text-white">
                            @Purchase.TotalQuantity articles
                        </td>
                        <td class="p-3 text-sm font-bold text-primary-700 text-right">
                            @Purchase.TotalAmount.ToString("N0") FCFA
                        </td>
                    </tr>
                </tfoot>
            }
        </table>
    </div>

    <!-- Status History Section -->
    <div class="mt-6">
        <div class="flex items-center justify-between mb-3">
            <h4 class="text-sm font-semibold text-gray-900 dark:text-white">Historique des statuts</h4>
            @if (isLoadingHistory)
            {
                <span class="text-xs text-gray-500">
                    <i class="fas fa-spinner fa-spin mr-1"></i> Chargement...
                </span>
            }
        </div>

        @if (!string.IsNullOrEmpty(historyErrorMessage))
        {
            <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-circle text-red-500 mr-2"></i>
                    <p class="text-red-700 text-sm">@historyErrorMessage</p>
                </div>
            </div>
        }
        else if (!isLoadingHistory && statusHistory.Any())
        {
            <div class="relative">
                <!-- Timeline -->
                <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-gray-200 dark:bg-gray-600"></div>

                <div class="space-y-4">
                    @foreach (var entry in statusHistory)
                    {
                        <div class="relative flex items-start pl-10">
                            <!-- Timeline dot -->
                            <div class="absolute left-2.5 w-3 h-3 rounded-full bg-primary-600 border-2 border-white dark:border-gray-800"></div>

                            <div class="flex-1 bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                                <div class="flex items-center justify-between mb-1">
                                    <div class="flex items-center gap-2">
                                        @if (!string.IsNullOrEmpty(entry.FromStatus))
                                        {
                                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium @GetStatusBadgeClass(entry.FromStatus)">
                                                @entry.FromStatus
                                            </span>
                                            <i class="fas fa-arrow-right text-gray-400 text-xs"></i>
                                        }
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium @GetStatusBadgeClass(entry.ToStatus)">
                                            @entry.ToStatus
                                        </span>
                                    </div>
                                    <span class="text-xs text-gray-500 dark:text-gray-400">
                                        @entry.Date.ToString("dd/MM/yyyy HH:mm")
                                    </span>
                                </div>
                                <div class="text-xs text-gray-600 dark:text-gray-300">
                                    <span class="font-medium">Par:</span> @(string.IsNullOrEmpty(entry.ChangedBy) ? "Systeme" : entry.ChangedBy)
                                </div>
                                @if (!string.IsNullOrEmpty(entry.Comment))
                                {
                                    <div class="mt-1 text-xs text-gray-500 dark:text-gray-400 italic">
                                        "@entry.Comment"
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
        else if (!isLoadingHistory)
        {
            <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg text-center">
                <i class="fas fa-history text-2xl text-gray-300 mb-2"></i>
                <p class="text-sm text-gray-500 dark:text-gray-400">Aucun historique de statut disponible</p>
            </div>
        }
    </div>
</div>

<div class="flex justify-end gap-3 px-6 py-4 border-t">
    <button class="text-white bg-primary-700 hover:bg-primary-800 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800"
            type="button" @onclick="OnClose">
        Fermer
    </button>
</div>

@code {
    [Parameter]
    public Purchase Purchase { get; set; } = new();

    [Parameter]
    public IEnumerable<Product> Products { get; set; } = new List<Product>();

    [Parameter]
    public EventCallback OnClose { get; set; }

    private List<PurchaseStatusHistory> statusHistory = new();
    private bool isLoadingHistory = false;
    private string historyErrorMessage = "";

    protected override async Task OnParametersSetAsync()
    {
        if (Purchase.Id != Guid.Empty && Purchase.BoutiqueId != Guid.Empty)
        {
            await LoadStatusHistory();
        }
    }

    private async Task LoadStatusHistory()
    {
        isLoadingHistory = true;
        historyErrorMessage = "";
        statusHistory = new();

        try
        {
            var response = await _purchaseService.GetPurchaseHistoryAsync(Purchase.Id, Purchase.BoutiqueId);
            if (response.Success && response.Data != null)
            {
                statusHistory = response.Data.History.ToList();
            }
            else
            {
                historyErrorMessage = response.Message ?? "Impossible de charger l'historique.";
            }
        }
        catch (Exception ex)
        {
            historyErrorMessage = "Erreur lors du chargement de l'historique.";
            Console.WriteLine($"Error loading purchase history: {ex.Message}");
        }
        finally
        {
            isLoadingHistory = false;
        }
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Brouillon" => "bg-yellow-100 text-yellow-800",
            "En attente de validation" => "bg-blue-100 text-blue-800",
            "Approuve" or "Approuvé" => "bg-green-100 text-green-800",
            "Rejete" or "Rejeté" => "bg-red-100 text-red-800",
            "Annule" or "Annulé" => "bg-gray-100 text-gray-800",
            _ => "bg-gray-100 text-gray-800"
        };
    }
}
