@page "/tresorerie/{boutiqueId:guid}/dashboard"
@using depensio.Shared.Pages.Tresoreries.Models
@inherits FlowbitePage
@layout MainLayout
@inject ITresorerieService _tresorerieService
@inject NavigationManager NavigationManager
@implements IDisposable

<PageTitleComponent Title="Tableau de bord tresorerie" />

<HeaderPage
    Title="Tableau de bord tresorerie"
    SubTitle="Vue d'ensemble de votre tresorerie"/>

@if (isLoading)
{
    <LoadingDataComponent />
}
else if (dashboard == null)
{
    <div class="bg-white rounded-lg shadow-md p-8 text-center">
        <i class="fas fa-exclamation-triangle text-6xl text-yellow-500 mb-4"></i>
        <p class="text-gray-600 text-lg">Impossible de recuperer les donnees du tableau de bord</p>
        <button @onclick="LoadDashboardAsync" class="mt-4 px-4 py-2 bg-primary-700 text-white rounded-lg hover:bg-amber-800">
            <i class="fas fa-refresh mr-2"></i>Reessayer
        </button>
    </div>
}
else
{
    <!-- Header avec actions -->
    <div class="mb-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <span class="text-sm text-gray-500">
                <i class="fas fa-clock mr-1"></i>
                Mis a jour le @dashboard.CalculatedAt.ToString("dd/MM/yyyy HH:mm:ss")
            </span>
            <button @onclick="RefreshDashboard"
                    disabled="@isRefreshing"
                    class="px-3 py-2 bg-primary-700 text-white rounded-lg hover:bg-amber-800 disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
                <i class="fas fa-sync-alt mr-2 @(isRefreshing ? "animate-spin" : "")"></i>
                Actualiser
            </button>
        </div>
        <div class="flex gap-3">
            <a href="/tresorerie/@boutiqueId/comptes"
               class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 flex items-center">
                <i class="fas fa-wallet mr-2"></i>Comptes
            </a>
            <a href="/tresorerie/@boutiqueId/flux"
               class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 flex items-center">
                <i class="fas fa-exchange-alt mr-2"></i>Flux
            </a>
        </div>
    </div>

    <!-- Solde total -->
    <div class="bg-gradient-to-r from-primary-700 to-amber-600 rounded-xl shadow-lg p-8 mb-6 text-white">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
            <div>
                <h2 class="text-lg opacity-80 mb-1">Solde total</h2>
                <p class="text-5xl font-bold mb-2">
                    @dashboard.TotalBalance.ToString("N0") FCFA
                </p>
                <p class="text-sm opacity-80">Tous comptes actifs confondus</p>
            </div>
            <div class="mt-4 md:mt-0">
                <i class="fas fa-wallet text-8xl opacity-20"></i>
            </div>
        </div>
    </div>

    <!-- Cartes par type de compte -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        @foreach (var accountType in Enum.GetValues<AccountType>())
        {
            var balance = dashboard.BalanceByType.ContainsKey(accountType) ? dashboard.BalanceByType[accountType] : 0;
            <div class="bg-white rounded-lg shadow-md p-4 border-l-4 @GetAccountTypeBorderColor(accountType)">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500 mb-1">@GetAccountTypeLabel(accountType)</p>
                        <p class="text-xl font-bold text-gray-900">@balance.ToString("N0") FCFA</p>
                    </div>
                    <div class="w-12 h-12 rounded-full flex items-center justify-center @GetAccountTypeBackgroundColor(accountType)">
                        <i class="@GetAccountTypeIcon(accountType) text-white text-lg"></i>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Flux du mois courant -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <!-- Revenus du mois -->
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 mb-1">Revenus du mois</p>
                    <p class="text-3xl font-bold text-green-600">
                        +@dashboard.MonthlyIncome.ToString("N0") FCFA
                    </p>
                    <p class="text-xs text-gray-400 mt-1">Flux approuves du mois</p>
                </div>
                <div class="w-16 h-16 rounded-full flex items-center justify-center bg-green-100">
                    <i class="fas fa-arrow-down text-green-600 text-2xl"></i>
                </div>
            </div>
        </div>

        <!-- Depenses du mois -->
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-red-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 mb-1">Depenses du mois</p>
                    <p class="text-3xl font-bold text-red-600">
                        -@dashboard.MonthlyExpense.ToString("N0") FCFA
                    </p>
                    <p class="text-xs text-gray-400 mt-1">Flux approuves du mois</p>
                </div>
                <div class="w-16 h-16 rounded-full flex items-center justify-center bg-red-100">
                    <i class="fas fa-arrow-up text-red-600 text-2xl"></i>
                </div>
            </div>
        </div>

        <!-- Solde net -->
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 @(dashboard.NetBalance >= 0 ? "border-green-500" : "border-red-500")">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 mb-1">Solde net du mois</p>
                    <p class="text-3xl font-bold @(dashboard.NetBalance >= 0 ? "text-green-600" : "text-red-600")">
                        @(dashboard.NetBalance >= 0 ? "+" : "")@dashboard.NetBalance.ToString("N0") FCFA
                    </p>
                    <p class="text-xs text-gray-400 mt-1">Revenus - Depenses</p>
                </div>
                <div class="w-16 h-16 rounded-full flex items-center justify-center @(dashboard.NetBalance >= 0 ? "bg-green-100" : "bg-red-100")">
                    <i class="fas @(dashboard.NetBalance >= 0 ? "fa-chart-line text-green-600" : "fa-chart-line text-red-600") text-2xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Flux en attente -->
    @if (dashboard.PendingCount > 0)
    {
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center bg-yellow-500 mr-4">
                        <i class="fas fa-clock text-white text-xl"></i>
                    </div>
                    <div>
                        <p class="text-lg font-semibold text-yellow-800">@dashboard.PendingCount flux en attente</p>
                        <p class="text-sm text-yellow-600">Montant total: @dashboard.PendingAmount.ToString("N0") FCFA</p>
                    </div>
                </div>
                <a href="/tresorerie/@boutiqueId/flux/pending"
                   class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 flex items-center">
                    <i class="fas fa-eye mr-2"></i>Voir les flux
                </a>
            </div>
        </div>
    }

    <!-- Alertes comptes -->
    @if (dashboard.Alerts.Any())
    {
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-exclamation-triangle mr-2 text-red-500"></i>Alertes comptes (@dashboard.Alerts.Count)
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                @foreach (var alert in dashboard.Alerts)
                {
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center @GetAccountTypeBackgroundColor(alert.Type) mr-3">
                                    <i class="@GetAccountTypeIcon(alert.Type) text-white text-sm"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-900">@alert.AccountName</p>
                                    <span class="text-xs @GetAccountTypeTextColor(alert.Type)">@GetAccountTypeLabel(alert.Type)</span>
                                </div>
                            </div>
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                                @GetAlertTypeLabel(alert.AlertType)
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm text-gray-500">Solde actuel</p>
                                <p class="text-lg font-bold text-red-600">@alert.CurrentBalance.ToString("N0") FCFA</p>
                            </div>
                            @if (alert.AlertThreshold.HasValue)
                            {
                                <div class="text-right">
                                    <p class="text-sm text-gray-500">Seuil</p>
                                    <p class="text-lg font-bold text-gray-900">@alert.AlertThreshold.Value.ToString("N0") FCFA</p>
                                </div>
                            }
                        </div>
                        <div class="mt-3 flex justify-end">
                            <a href="/tresorerie/@boutiqueId/comptes/@alert.AccountId"
                               class="text-sm text-blue-600 hover:text-blue-800">
                                <i class="fas fa-eye mr-1"></i>Voir le compte
                            </a>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Evolution sur 6 mois -->
    @if (dashboard.Evolution.Any())
    {
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-chart-line mr-2 text-primary-700"></i>Evolution mensuelle
            </h3>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Mois</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Revenus</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Depenses</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Solde</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        @foreach (var evolution in dashboard.Evolution.OrderByDescending(e => e.Date))
                        {
                            <tr>
                                <td class="px-4 py-3 text-sm text-gray-900">@evolution.Date.ToString("MMMM yyyy")</td>
                                <td class="px-4 py-3 text-sm text-right text-green-600">+@evolution.TotalIncome.ToString("N0")</td>
                                <td class="px-4 py-3 text-sm text-right text-red-600">-@evolution.TotalExpense.ToString("N0")</td>
                                <td class="px-4 py-3 text-sm text-right font-semibold @(evolution.Balance >= 0 ? "text-green-600" : "text-red-600")">
                                    @evolution.Balance.ToString("N0")
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Graphique simple des barres -->
            <div class="mt-6">
                <div class="flex items-end justify-between gap-2 h-40">
                    @foreach (var evolution in dashboard.Evolution.OrderBy(e => e.Date).TakeLast(6))
                    {
                        var maxValue = dashboard.Evolution.Max(e => Math.Max(e.TotalIncome, e.TotalExpense));
                        var incomeHeight = maxValue > 0 ? (evolution.TotalIncome / maxValue) * 100 : 0;
                        var expenseHeight = maxValue > 0 ? (evolution.TotalExpense / maxValue) * 100 : 0;

                        <div class="flex-1 flex flex-col items-center">
                            <div class="flex gap-1 items-end h-32">
                                <div class="w-4 bg-green-500 rounded-t" style="height: @incomeHeight.ToString(System.Globalization.CultureInfo.InvariantCulture)%"></div>
                                <div class="w-4 bg-red-500 rounded-t" style="height: @expenseHeight.ToString(System.Globalization.CultureInfo.InvariantCulture)%"></div>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">@evolution.Date.ToString("MMM")</p>
                        </div>
                    }
                </div>
                <div class="flex justify-center gap-4 mt-2">
                    <div class="flex items-center gap-1">
                        <div class="w-3 h-3 bg-green-500 rounded"></div>
                        <span class="text-xs text-gray-500">Revenus</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-3 h-3 bg-red-500 rounded"></div>
                        <span class="text-xs text-gray-500">Depenses</span>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Actions rapides -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-bolt mr-2 text-primary-700"></i>Actions rapides
        </h3>
        <div class="flex flex-wrap gap-3">
            <a href="/tresorerie/@boutiqueId/comptes"
               class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                <i class="fas fa-wallet mr-2"></i>Gerer les comptes
            </a>
            <a href="/tresorerie/@boutiqueId/flux"
               class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center">
                <i class="fas fa-exchange-alt mr-2"></i>Voir tous les flux
            </a>
            <a href="/tresorerie/@boutiqueId/budgets"
               class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center">
                <i class="fas fa-chart-pie mr-2"></i>Gerer les budgets
            </a>
            <a href="/tresorerie/@boutiqueId/budgets/alerts"
               class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 flex items-center">
                <i class="fas fa-bell mr-2"></i>Alertes budgetaires
            </a>
        </div>
    </div>
}

@code {
    [Parameter]
    public Guid boutiqueId { get; set; }

    private TreasuryDashboardDto? dashboard;
    private bool isLoading = true;
    private bool isRefreshing = false;
    private System.Timers.Timer? autoRefreshTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardAsync();
        SetupAutoRefresh();
    }

    private void SetupAutoRefresh()
    {
        autoRefreshTimer = new System.Timers.Timer(60000);
        autoRefreshTimer.Elapsed += async (sender, args) =>
        {
            await InvokeAsync(async () =>
            {
                await RefreshDashboard();
            });
        };
        autoRefreshTimer.AutoReset = true;
        autoRefreshTimer.Start();
    }

    private async Task LoadDashboardAsync()
    {
        try
        {
            var response = await _tresorerieService.GetTreasuryDashboardAsync(boutiqueId);
            if (response.Success && response.Data != null)
            {
                dashboard = response.Data;
            }
            else
            {
                dashboard = null;
            }
        }
        catch (Exception)
        {
            dashboard = null;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshDashboard()
    {
        isRefreshing = true;
        StateHasChanged();

        try
        {
            var response = await _tresorerieService.GetTreasuryDashboardAsync(boutiqueId);
            if (response.Success && response.Data != null)
            {
                dashboard = response.Data;
            }
        }
        catch (Exception)
        {
            // On garde les donnees precedentes en cas d'erreur
        }
        finally
        {
            isRefreshing = false;
            StateHasChanged();
        }
    }

    private string GetAccountTypeLabel(AccountType type) => type switch
    {
        AccountType.CASH => "Especes",
        AccountType.BANK => "Banque",
        AccountType.MOBILE_MONEY => "Mobile Money",
        AccountType.OTHER => "Autre",
        _ => "Inconnu"
    };

    private string GetAccountTypeBorderColor(AccountType type) => type switch
    {
        AccountType.CASH => "border-green-500",
        AccountType.BANK => "border-blue-500",
        AccountType.MOBILE_MONEY => "border-orange-500",
        AccountType.OTHER => "border-gray-500",
        _ => "border-gray-500"
    };

    private string GetAccountTypeBackgroundColor(AccountType type) => type switch
    {
        AccountType.CASH => "bg-green-500",
        AccountType.BANK => "bg-blue-500",
        AccountType.MOBILE_MONEY => "bg-orange-500",
        AccountType.OTHER => "bg-gray-500",
        _ => "bg-gray-500"
    };

    private string GetAccountTypeTextColor(AccountType type) => type switch
    {
        AccountType.CASH => "text-green-600",
        AccountType.BANK => "text-blue-600",
        AccountType.MOBILE_MONEY => "text-orange-600",
        AccountType.OTHER => "text-gray-600",
        _ => "text-gray-600"
    };

    private string GetAccountTypeIcon(AccountType type) => type switch
    {
        AccountType.CASH => "fas fa-money-bill-wave",
        AccountType.BANK => "fas fa-university",
        AccountType.MOBILE_MONEY => "fas fa-mobile-alt",
        AccountType.OTHER => "fas fa-wallet",
        _ => "fas fa-wallet"
    };

    private string GetAlertTypeLabel(string alertType) => alertType switch
    {
        "LOW_BALANCE" => "Solde bas",
        "BUDGET_EXCEEDED" => "Budget depasse",
        _ => alertType
    };

    public void Dispose()
    {
        autoRefreshTimer?.Stop();
        autoRefreshTimer?.Dispose();
    }
}
