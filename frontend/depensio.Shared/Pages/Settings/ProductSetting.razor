@page "/settings/{boutiqueId:guid}/product"
@page "/settings/{boutiqueId:guid}"
@using System.ComponentModel.DataAnnotations
@using System.Reflection
@using depensio.Shared.Enums
@using depensio.Shared.Helpers
@using depensio.Shared.Pages.Boutique.Model
@using depensio.Shared.Pages.Produits.Components
@using depensio.Shared.Pages.Produits.Models
@inject ToastService ToastService
@inherits FlowbitePage
@layout MainLayout
@inject IBoutiqueSettingService _boutiqueSettingService
@inject HeaderTabService _headerTabService

<PageTitle>Depensio - Paramètres des produits</PageTitle>

<ToastContainer />
<LoadingComponent IsLoad="@isLoad" />

<HeaderPanel Tabs="@headerTabs" />

<div class="grid grid-cols-1 px-4 xl:grid-cols-2 xl:gap-4">
    <div class="p-4 mb-4 bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 sm:p-6 dark:bg-gray-800 xl:mb-0">
        @if (@settingCodeBar != null)
        {

            <EditForm Model="formModel" OnValidSubmit="HandleBarCodeSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary />
                <div class="flow-root">
                    @* <h3 class="text-xl font-semibold dark:text-white">Alerts & Notifications</h3>
                    <p class="text-sm font-normal text-gray-500 dark:text-gray-400">You can set up Themesberg to get notifications</p> *@
                    <div class="divide-y divide-gray-200 dark:divide-gray-700">

                        <div class="flex items-center justify-between py-4">
                            <div class="flex flex-col flex-grow">
                                <div class="text-lg font-semibold text-gray-900 dark:text-white">@settingCodeBar.LabelValue</div>
                                <div class="text-base font-normal text-gray-500 dark:text-gray-400">@settingCodeBar.Description</div>
                            </div>
                            <div class="relative inline-block w-200 h-5">
                                <select @bind="formModel.GenerationMode" id="prodctId" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500">
                                    @*  <option selected="">Choix de produit</option> *@
                                    @foreach (var mode in Enum.GetValues<BarcodeGenerationMode>())
                                    {
                                        <option value="@mode">@GetDisplayName(mode)</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <ValidationMessage For="@(() => formModel.GenerationMode)" />

                    </div>
                    <div class="mt-6">
                        <button class="text-white bg-primary-700 hover:bg-primary-800 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800">Enregistrer</button>
                    </div>
                </div>

            </EditForm>

        }

    </div>
    <div class="p-4 mb-4 bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 sm:p-6 dark:bg-gray-800 xl:mb-0">
        @if (@settingStock != null)
        {

            <EditForm Model="formModel" OnValidSubmit="HandleStockSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary />
                <div class="flow-root">

                    <div class="divide-y divide-gray-200 dark:divide-gray-700">

                        <div class="flex items-center justify-between py-4">
                            <div class="flex flex-col flex-grow">
                                <div class="text-lg font-semibold text-gray-900 dark:text-white">@settingStock.LabelValue</div>
                                <div class="text-base font-normal text-gray-500 dark:text-gray-400">@settingStock.Description</div>
                            </div>
                            <div class="relative inline-block w-11 h-5">
                                <input id="switch-component" @bind="formModel.StockAuto" type="checkbox" class="peer appearance-none w-11 h-5 bg-slate-100 rounded-full checked:bg-primary-800 cursor-pointer transition-colors duration-300" />
                                <label for="switch-component" class="absolute top-0 left-0 w-5 h-5 bg-white rounded-full border border-slate-300 shadow-sm transition-transform duration-300 peer-checked:translate-x-6 peer-checked:border-slate-800 cursor-pointer">
                                </label>
                            </div>
                        </div>
                        <ValidationMessage For="@(() => formModel.StockAuto)" />

                    </div>
                    <div class="mt-6">
                        <button class="text-white bg-primary-700 hover:bg-primary-800 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800">Enregistrer</button>
                    </div>
                </div>


            </EditForm>

        }

    </div>
</div>

@code {
    [Parameter]
    public Guid boutiqueId { get; set; }
    private bool isLoad = false;

    private BoutiqueSettingValue settingCodeBar;
    private BoutiqueSettingValue settingStock;

    private ProductFormModel formModel = new();

    private EditContext editContext;
    private ValidationMessageStore messageStore;

    private List<HeaderTab> headerTabs = new();

    protected override async Task OnInitializedAsync()
    {
        var setting = await _boutiqueSettingService.GetSettingByBoutique(boutiqueId, BoutiqueSettingKeys.PRODUCT_KEY);
        var result = JsonSerializer.Deserialize<List<BoutiqueSettingValue>>(setting.Data.Settings.Value);

        settingCodeBar = result?.FirstOrDefault(x => x.Id == BoutiqueSettingKeys.PRODUCT_BARCODE_GENERATION_MODE);
        settingStock = result?.FirstOrDefault(x => x.Id == BoutiqueSettingKeys.PRODUCT_STOCK_AUTOMATIQUE);

        formModel.GenerationMode = EnumHelper.ParseOrDefault<BarcodeGenerationMode>(settingCodeBar.Value.ToString(), BarcodeGenerationMode.Auto);
        formModel.StockAuto = BoolHelper.ToBool(settingStock.Value.ToString());

        headerTabs = _headerTabService.GetHeaderTabs(boutiqueId);

    }

    private async void HandleStockSubmit()
    {
        //isLoad = true;
        try
        {
            var setting = await _boutiqueSettingService.GetSettingByBoutique(boutiqueId, BoutiqueSettingKeys.PRODUCT_KEY);

            if (setting?.Data?.Settings?.Value is not string json)
            {
                Console.Error.WriteLine("Erreur : Valeur des param�tres produit non disponible ou invalide.");
                return;
            }

            var result = JsonSerializer.Deserialize<List<BoutiqueSettingValue>>(json);
            if (result is null)
            {
                throw new InvalidOperationException("Erreur de d�s�rialisation des param�tres.");
            }

            var stockSetting = result.FirstOrDefault(x => x.Id == BoutiqueSettingKeys.PRODUCT_STOCK_AUTOMATIQUE);
            if (stockSetting is not null)
            {
                stockSetting.Value = formModel.StockAuto.ToString();
            }

            setting.Data.Settings.Value = JsonSerializer.Serialize(result);
            setting.Data.Settings.BoutiqueId = boutiqueId;

            var saveResult = await _boutiqueSettingService.UpsetSettingByBoutique(
                new UpsetSettingByBoutiqueRequest(setting.Data.Settings)
            );
            ShowSuccess();
        }
        catch
        {
            ShowError();
        }
        finally
        {
            //isLoad = false;
        }


    }

    private async void HandleBarCodeSubmit()
    {
        //isLoad = true;
        try
        {
            var setting = await _boutiqueSettingService.GetSettingByBoutique(boutiqueId, BoutiqueSettingKeys.PRODUCT_KEY);

            if (setting?.Data?.Settings?.Value is not string json)
            {
                throw new InvalidOperationException("Valeur des param�tres produit non disponible ou invalide.");
            }

            var result = JsonSerializer.Deserialize<List<BoutiqueSettingValue>>(json);
            if (result is null)
            {
                throw new InvalidOperationException("Erreur de d�s�rialisation des param�tres.");
            }

            var barcodeSetting = result.FirstOrDefault(x => x.Id == BoutiqueSettingKeys.PRODUCT_BARCODE_GENERATION_MODE);
            if (barcodeSetting is not null)
            {
                barcodeSetting.Value = formModel.GenerationMode.ToString();
            }

            setting.Data.Settings.Value = JsonSerializer.Serialize(result);
            setting.Data.Settings.BoutiqueId = boutiqueId;

            var saveResult = await _boutiqueSettingService.UpsetSettingByBoutique(
                new UpsetSettingByBoutiqueRequest(setting.Data.Settings)
            );

            ShowSuccess();
        }
        catch
        {
            ShowError();
        }
        finally
        {
            //isLoad = false;
        }


    }


    private string GetDisplayName(Enum value)
    {
        var field = value.GetType().GetField(value.ToString());
        var attr = field?.GetCustomAttribute<DisplayAttribute>();
        return attr?.Name ?? value.ToString();
    }


    private void ShowSuccess()
    {
        ToastService.ShowToast("Succès", "Paramètre enregistré avec succès", "success");
    }

    private void ShowError()
    {
        ToastService.ShowToast("Erreur", "Une erreur est survenue", "error");
    }

}