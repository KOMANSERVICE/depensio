@page "/settings/{boutiqueId:guid}/sale"
@using depensio.Shared.Pages.Boutique.Model
@using depensio.Shared.Pages.Produits.Components
@using depensio.Shared.Pages.Produits.Models
@inject ToastService ToastService
@inherits FlowbitePage
@layout MainLayout
@inject IBoutiqueSettingService _boutiqueSettingService

<PageTitle>Depensio - Paramètres des ventes</PageTitle>

<ToastContainer />
<div class="border-b border-gray-200 dark:border-gray-700">
    <ul class="flex flex-wrap -mb-px text-sm font-medium text-center text-gray-500 dark:text-gray-400">
        <li class="me-2">
            <NavLink href="@($"/settings/{boutiqueId}")" class="inline-flex items-center justify-center p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-700 hover:border-gray-300 dark:hover:text-gray-300 group">
                <svg class="w-4 h-4 me-2 text-gray-400 group-hover:text-gray-500 dark:text-gray-500 dark:group-hover:text-gray-300" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 0a10 10 0 1 0 10 10A10.011 10.011 0 0 0 10 0Zm0 5a3 3 0 1 1 0 6 3 3 0 0 1 0-6Zm0 13a8.949 8.949 0 0 1-4.951-1.488A3.987 3.987 0 0 1 9 13h2a3.987 3.987 0 0 1 3.951 3.512A8.949 8.949 0 0 1 10 18Z" />
                </svg>Tableau de bord
            </NavLink>
        </li>
        <li class="me-2">
            <NavLink href="@($"/settings/{boutiqueId}/product")" class="inline-flex items-center justify-center p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-700 hover:border-gray-300 dark:hover:text-gray-300 group">
                <svg class="w-4 h-4 me-2 text-gray-400 group-hover:text-gray-500 dark:text-gray-500 dark:group-hover:text-gray-300" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M5 11.424V1a1 1 0 1 0-2 0v10.424a3.228 3.228 0 0 0 0 6.152V19a1 1 0 1 0 2 0v-1.424a3.228 3.228 0 0 0 0-6.152ZM19.25 14.5A3.243 3.243 0 0 0 17 11.424V1a1 1 0 0 0-2 0v10.424a3.227 3.227 0 0 0 0 6.152V19a1 1 0 1 0 2 0v-1.424a3.243 3.243 0 0 0 2.25-3.076Zm-6-9A3.243 3.243 0 0 0 11 2.424V1a1 1 0 0 0-2 0v1.424a3.228 3.228 0 0 0 0 6.152V19a1 1 0 1 0 2 0V8.576A3.243 3.243 0 0 0 13.25 5.5Z" />
                </svg>Produit
            </NavLink>
        </li>
        <li class="me-2">
            <NavLink href="@($"/settings/{boutiqueId}/purchase")" class="inline-flex items-center justify-center p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-700 hover:border-gray-300 dark:hover:text-gray-300 group">
                <svg class="w-4 h-4 me-2 text-primary-700 dark:text-primary-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 18 18">
                    <path d="M6.143 0H1.857A1.857 1.857 0 0 0 0 1.857v4.286C0 7.169.831 8 1.857 8h4.286A1.857 1.857 0 0 0 8 6.143V1.857A1.857 1.857 0 0 0 6.143 0Zm10 0h-4.286A1.857 1.857 0 0 0 10 1.857v4.286C10 7.169 10.831 8 11.857 8h4.286A1.857 1.857 0 0 0 18 6.143V1.857A1.857 1.857 0 0 0 16.143 0Zm-10 10H1.857A1.857 1.857 0 0 0 0 11.857v4.286C0 17.169.831 18 1.857 18h4.286A1.857 1.857 0 0 0 8 16.143v-4.286A1.857 1.857 0 0 0 6.143 10Zm10 0h-4.286A1.857 1.857 0 0 0 10 11.857v4.286c0 1.026.831 1.857 1.857 1.857h4.286A1.857 1.857 0 0 0 18 16.143v-4.286A1.857 1.857 0 0 0 16.143 10Z" />
                </svg>
                Achat
            </NavLink>
        </li>
        <li class="me-2">
            <NavLink href="@($"/settings/{boutiqueId}/sale")" class="inline-flex items-center justify-center p-4 text-primary-700 border-b-2 border-primary-700 rounded-t-lg active dark:text-primary-500 dark:border-primary-500 group" aria-current="page">
                <svg class="w-4 h-4 me-2 text-gray-400 group-hover:text-gray-500 dark:text-gray-500 dark:group-hover:text-gray-300" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 18 20">
                    <path d="M16 1h-3.278A1.992 1.992 0 0 0 11 0H7a1.993 1.993 0 0 0-1.722 1H2a2 2 0 0 0-2 2v15a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2Zm-3 14H5a1 1 0 0 1 0-2h8a1 1 0 0 1 0 2Zm0-4H5a1 1 0 0 1 0-2h8a1 1 0 1 1 0 2Zm0-5H5a1 1 0 0 1 0-2h2V2h4v2h2a1 1 0 1 1 0 2Z" />
                </svg>Caisser
            </NavLink>
        </li>
        @* <li>
            <a class="inline-block p-4 text-gray-400 rounded-t-lg cursor-not-allowed dark:text-gray-500">Disabled</NavLink>
        </li> *@
    </ul>
</div>

<div class="grid grid-cols-1 px-4 xl:grid-cols-2 xl:gap-4">
    <div class="p-4 mb-4 bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 sm:p-6 dark:bg-gray-800 xl:mb-0">
        @if (@settingSaisiePrix != null)
        {

            <EditForm Model="formModel" OnValidSubmit="HandleBarCodeSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary />
                <div class="flow-root">
                    @* <h3 class="text-xl font-semibold dark:text-white">Alerts & Notifications</h3>
                    <p class="text-sm font-normal text-gray-500 dark:text-gray-400">You can set up Themesberg to get notifications</p> *@
                    <div class="divide-y divide-gray-200 dark:divide-gray-700">

                        <div class="flex items-center justify-between py-4">
                            <div class="flex flex-col flex-grow">
                                <div class="text-lg font-semibold text-gray-900 dark:text-white">@settingSaisiePrix.LabelValue</div>
                                <div class="text-base font-normal text-gray-500 dark:text-gray-400">@settingSaisiePrix.Description</div>
                            </div>
                            <div class="relative inline-block w-11 h-5">
                                <input id="autoprix" @bind="formModel.AutoSaisiPrix" type="checkbox" class="peer appearance-none w-11 h-5 bg-slate-100 rounded-full checked:bg-primary-800 cursor-pointer transition-colors duration-300" />
                                <label for="autoprix" class="absolute top-0 left-0 w-5 h-5 bg-white rounded-full border border-slate-300 shadow-sm transition-transform duration-300 peer-checked:translate-x-6 peer-checked:border-slate-800 cursor-pointer">
                                </label>
                            </div>
                        </div>
                        <ValidationMessage For="@(() => formModel.AutoSaisiPrix)" />

                    </div>
                    <div class="mt-6">
                        <button class="text-white bg-primary-700 hover:bg-primary-800 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800">Enregistrer</button>
                    </div>
                </div>

            </EditForm>

        }

    </div>
    <div class="p-4 mb-4 bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 sm:p-6 dark:bg-gray-800 xl:mb-0">
        @if (@settingVenteStockZero != null)
        {

            <EditForm Model="formModel" OnValidSubmit="HandleStockSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary />
                <div class="flow-root">

                    <div class="divide-y divide-gray-200 dark:divide-gray-700">

                        <div class="flex items-center justify-between py-4">
                            <div class="flex flex-col flex-grow">
                                <div class="text-lg font-semibold text-gray-900 dark:text-white">@settingVenteStockZero.LabelValue</div>
                                <div class="text-base font-normal text-gray-500 dark:text-gray-400">@settingVenteStockZero.Description</div>
                            </div>
                            <div class="relative inline-block w-11 h-5">
                                <input id="ventwithstock" @bind="formModel.AutoVenteProduitSkockZero" type="checkbox" class="peer appearance-none w-11 h-5 bg-slate-100 rounded-full checked:bg-primary-800 cursor-pointer transition-colors duration-300" />
                                <label for="ventwithstock" class="absolute top-0 left-0 w-5 h-5 bg-white rounded-full border border-slate-300 shadow-sm transition-transform duration-300 peer-checked:translate-x-6 peer-checked:border-slate-800 cursor-pointer">
                                </label>
                            </div>
                        </div>
                        <ValidationMessage For="@(() => formModel.AutoVenteProduitSkockZero)" />

                    </div>
                    <div class="mt-6">
                        <button class="text-white bg-primary-700 hover:bg-primary-800 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800">Enregistrer</button>
                    </div>
                </div>


            </EditForm>

        }

    </div>
</div>

@code {
    [Parameter]
    public Guid boutiqueId { get; set; }
    private bool isLoad = false;

    private BoutiqueSettingValue settingSaisiePrix;
    private BoutiqueSettingValue settingVenteStockZero;

    private ProductFormModel formModel = new();

    private EditContext editContext;
    private ValidationMessageStore messageStore;

    protected override async Task OnInitializedAsync()
    {
        var setting = await _boutiqueSettingService.GetSettingByBoutique(boutiqueId, BoutiqueSettingKeys.VENTE_KEY);
        var result = JsonSerializer.Deserialize<List<BoutiqueSettingValue>>(setting.Data.Settings.Value);

        settingSaisiePrix = result?.FirstOrDefault(x => x.Id == BoutiqueSettingKeys.VENTE_AUTORISER_MODIFICATION_PRIX);
        settingVenteStockZero = result?.FirstOrDefault(x => x.Id == BoutiqueSettingKeys.VENTE_AUTORISER_VENTE_AVEC_STOCK_ZERO);

        formModel.AutoSaisiPrix = BoolHelper.ToBool(settingSaisiePrix.Value.ToString());
        formModel.AutoVenteProduitSkockZero = BoolHelper.ToBool(settingVenteStockZero.Value.ToString());


    }

    private async void HandleStockSubmit()
    {
        //isLoad = true;
        try
        {
            var setting = await _boutiqueSettingService.GetSettingByBoutique(boutiqueId, BoutiqueSettingKeys.VENTE_KEY);

            if (setting?.Data?.Settings?.Value is not string json)
            {
                ShowError();
                return;
            }

            var result = JsonSerializer.Deserialize<List<BoutiqueSettingValue>>(json);
            if (result is null)
            {
                ShowError();
                return;
            }

            var stockSetting = result.FirstOrDefault(x => x.Id == BoutiqueSettingKeys.VENTE_AUTORISER_VENTE_AVEC_STOCK_ZERO);
            if (stockSetting is not null)
            {
                stockSetting.Value = formModel.AutoVenteProduitSkockZero.ToString();
            }

            setting.Data.Settings.Value = JsonSerializer.Serialize(result);
            setting.Data.Settings.BoutiqueId = boutiqueId;

            var saveResult = await _boutiqueSettingService.UpsetSettingByBoutique(
                new UpsetSettingByBoutiqueRequest(setting.Data.Settings)
            );
            ShowSuccess();
        }
        catch
        {
            ShowError();
        }
        finally
        {
            //isLoad = false;
        }


    }

    private async void HandleBarCodeSubmit()
    {
        //isLoad = true;
        try
        {
            var setting = await _boutiqueSettingService.GetSettingByBoutique(boutiqueId, BoutiqueSettingKeys.VENTE_KEY);

            if (setting?.Data?.Settings?.Value is not string json)
            {
                ShowError();
                return;
            }

            var result = JsonSerializer.Deserialize<List<BoutiqueSettingValue>>(json);
            if (result is null)
            {
                ShowError();
                return;
            }

            var barcodeSetting = result.FirstOrDefault(x => x.Id == BoutiqueSettingKeys.VENTE_AUTORISER_MODIFICATION_PRIX);
            if (barcodeSetting is not null)
            {
                barcodeSetting.Value = formModel.AutoSaisiPrix.ToString();
            }

            setting.Data.Settings.Value = JsonSerializer.Serialize(result);
            setting.Data.Settings.BoutiqueId = boutiqueId;

            var saveResult = await _boutiqueSettingService.UpsetSettingByBoutique(
                new UpsetSettingByBoutiqueRequest(setting.Data.Settings)
            );

            ShowSuccess();
        }
        catch
        {
            ShowError();
        }
        finally
        {
            //isLoad = false;
        }


    }


    private string GetDisplayName(Enum value)
    {
        var field = value.GetType().GetField(value.ToString());
        var attr = field?.GetCustomAttribute<DisplayAttribute>();
        return attr?.Name ?? value.ToString();
    }

    private void ShowSuccess()
    {
        ToastService.ShowToast("Succès", "Paramètre enregistré avec succès", "success");
    }

    private void ShowError()
    {
        ToastService.ShowToast("Erreur", "Une erreur est survenue", "error");
    }

}