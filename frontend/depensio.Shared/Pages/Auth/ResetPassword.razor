@page "/reset-password/{userId}"
@inject IAuthHttpService _auth
@inject NavigationManager NavManager
@layout NoContentLayout


<PageTitleComponent Title="Reinitialisation de mot de passe" />

<LoadingComponent IsLoad="@isLoad" />

<div class="min-h-screen flex items-center justify-center">
    <div class="w-full max-w-md mx-4">
        <div class="bg-white rounded-xl shadow-lg p-8 transition-all duration-200 transform hover:-translate-y-1 hover:shadow-xl">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Créer un nouveau mot de passe</h1>
                <p class="text-gray-600">Votre nouveau mot de passe doit être différent des précédents</p>
            </div>

            <EditForm EditContext="@editContext" OnValidSubmit="HandleResetPassword">
                <DataAnnotationsValidator />
                <ValidationSummaryFancy editContext="@editContext" />
                <div class="space-y-6">

                    <div class="relative">
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Nouveau mot de passe</label>
                        <div class="relative">
                            <InputText type="password" @bind-Value="resetPassword.NewPassword" id="password"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-primary-700 focus:ring-1 focus:ring-primary-700 focus:outline-none transition-all duration-200 password-input"
                                       placeholder="••••••••" />
                            <button type="button" class="absolute password-toggle text-gray-400 hover:text-gray-600 focus:outline-none" onclick="togglePassword('password')">
                                <i data-feather="eye" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div id="password-error" class="error-message">
                            <ValidationMessage For="@(() => resetPassword.NewPassword)" />
                        </div>
                    </div>

                    <div class="relative">
                        <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1">Confirmer le mot de passe</label>
                        <div class="relative">
                            <InputText type="password" @bind-Value="resetPassword.ConfirmPassword" id="confirmPassword"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none transition-colors duration-200 password-input"
                                       placeholder="••••••••" />
                            <button type="button" class="absolute password-toggle text-gray-400 hover:text-gray-600 focus:outline-none" onclick="togglePassword('confirmPassword')">
                                <i data-feather="eye" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div id="password-error" class="error-message">
                            <ValidationMessage For="@(() => resetPassword.ConfirmPassword)" />
                        </div>
                    </div>

                    <div class="flex items-center">
                        <input id="terms" type="checkbox" class="rounded text-primary-700 focus:ring-primary-700">
                        <label for="terms" class="ml-2 block text-sm text-gray-700">
                            J'accepte les <a href="#" class="text-primary-700 hover:text-[#a3722c]">conditions d'utilisation</a>
                        </label>
                    </div>
                    <button type="submit" class="w-full px-6 py-3 rounded-lg font-medium text-white bg-primary-700 hover:bg-[#a3722c] transition-all duration-200 transform hover:-translate-y-0.5 hover:shadow-md">
                        Réinitialiser le mot de passe
                    </button>
                </div>

            </EditForm>
        </div>

        <div class="text-center mt-6 text-sm text-gray-500">
            <p>Vous vous souvenez de votre mot de passe? <NavLink href="/login" class="text-primary-700 hover:text-[#a3722c]">Se connecter</NavLink></p>
        </div>
    </div>
</div>


@code {
    [Parameter]
    public string? userId { get; set; }

    [SupplyParameterFromQuery]
    public string? Code { get; set; }

    private bool isLoad = false;
    private bool isSuccess = false;

    ResetPasswordDTO resetPassword = new();
    private ErrorMessage errorMessage = new();

    private EditContext editContext;
    private ValidationMessageStore messageStore;


    protected override void OnInitialized()
    {
        editContext = new EditContext(resetPassword);
        messageStore = new ValidationMessageStore(editContext);

        editContext.OnValidationRequested += (s, e) => messageStore.Clear();
        editContext.OnFieldChanged += (s, e) => messageStore.Clear(e.FieldIdentifier);
    }



    private string message = "";

    private async Task HandleResetPassword()
    {
        isLoad = true;
        StateHasChanged();
        try
        {
            resetPassword.Token = Code;
            resetPassword.Id = userId;
            var resetPass = await _auth.ResetPasswordAsync(new ResetPasswordRequest(resetPassword));
            if (resetPass.Success)
            {
                NavManager.NavigateTo("traitmentsuccess");
            }
        }

        catch (ApiException ex)
        {
            try
            {
                var errorResult = JsonSerializer.Deserialize<ErrorMessage>(ex.Content, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                });

                // Efface les anciennes erreurs
                messageStore.Clear();

                if (errorResult?.ValidationErrors != null && errorResult.ValidationErrors.Any())
                {
                    foreach (var validationError in errorResult.ValidationErrors)
                    {
                        // Nettoyer le nom de propriété (ex: Product.Name -> Name)
                        var propertyName = validationError.PropertyName;
                        if (propertyName.Contains('.'))
                            propertyName = propertyName.Split('.').Last();

                        // Associer au champ si possible
                        var fieldIdentifier = new FieldIdentifier(resetPassword!, propertyName);
                        messageStore.Add(fieldIdentifier, validationError.ErrorMessage);
                    }
                }
                else if (!string.IsNullOrWhiteSpace(errorResult?.Detail))
                {
                    // Message global sans champ spécifique
                    var fieldIdentifier = new FieldIdentifier(resetPassword!, string.Empty);
                    messageStore.Add(fieldIdentifier, errorResult.Detail);
                }

                // Rafraîchir l’affichage
                editContext.NotifyValidationStateChanged();

            }
            catch
            {
                messageStore.Add(new FieldIdentifier(resetPassword, string.Empty), "Une erreur est survenue.");
                editContext.NotifyValidationStateChanged();
            }
        }
        finally
        {
            isLoad = false;
        }
    }
}
