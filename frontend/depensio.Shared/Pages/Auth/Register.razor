@page "/register"
@inherits FlowbitePage
@inject NavigationManager NavManager
@inject IAuthHttpService _authService
@layout NoContentLayout
@inject IFormFactor FormFactor

<PageTitleComponent Title="Inscription" />

<LoadingComponent IsLoad="@isLoad" />
<section class="bg-gradient-to-r from-primary-700/10 to-primary-700/5 min-h-screen">
    <div class="min-h-screen flex flex-col lg:flex-row">
        <!-- Section gauche (illustration) -->
        <div class="lg:w-1/2 bg-primary-700 flex items-center justify-center p-12 text-white">
            <div class="max-w-md text-center">
                <div class="text-5xl mb-6">
                    <i class="fas fa-store"></i>
                </div>
                <h1 class="text-4xl font-bold mb-4">Depensio</h1>
                <p class="text-xl opacity-90 mb-8">Pilotez toutes vos entreprises en ligne depuis une seule interface</p>
                <div class="flex justify-center space-x-4 mb-8">
                    <div class="w-12 h-12 rounded-full bg-white bg-opacity-20 flex items-center justify-center">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-white bg-opacity-20 flex items-center justify-center">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-white bg-opacity-20 flex items-center justify-center">
                        <i class="fas fa-users-cog"></i>
                    </div>
                </div>
                @if (factor.Contains("web", StringComparison.OrdinalIgnoreCase))
                {
                    <div class="flex justify-center items-center mb-8">
                        <svg class="w-6 h-6 text-white dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12l4-4m-4 4 4 4" />
                        </svg>
                        <NavLink href="/" class="text-xl opacity-90">
                            Retour à l'accueil
                        </NavLink>
                    </div>
                }

            </div>
        </div>

        <!-- Section droite (formulaire) -->
        <div class="lg:w-1/2 flex items-center justify-center p-12">
            <div class="w-full max-w-md">
                <div class="text-center mb-10">
                    <h2 class="text-3xl font-bold text-gray-800">Créez votre compte</h2>
                    <p class="text-gray-600 mt-2">Commencez votre expérience avec Depensio</p>
                </div>
                <EditForm EditContext="@editContext" OnValidSubmit="HandleRegister">
                    <DataAnnotationsValidator />
                    <ErrorsSummary editContext="@editContext" />
                    
                    
                    <div id="error-summary" class="error-summary hidden">
                        <h3 class="font-medium text-red-600">Veuillez corriger les erreurs suivantes :</h3>
                        <ul id="error-list" class="list-disc pl-5 mt-2 space-y-1"></ul>
                    </div>

                    <div id="register-form" class="space-y-6" novalidate>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Adresse email *</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-envelope text-gray-400"></i>
                                </div>
                                <InputText @bind-Value="registerModel.Email" type="email" id="email" name="email"
                                           class="pl-10 block w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-700 focus:border-transparent transition duration-200"
                                           placeholder="votre@email.com" />
                            </div>
                            <div id="email-error" class="error-message">
                                <ValidationMessage For="@(() => registerModel.Email)" />
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="lastname" class="block text-sm font-medium text-gray-700 mb-1">Nom *</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-user text-gray-400"></i>
                                    </div>
                                    <InputText @bind-Value="registerModel.LastName" type="text" id="lastname" name="lastname"
                                               class="pl-10 block w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-700 focus:border-transparent transition duration-200"
                                               placeholder="Votre nom" />
                                </div>
                                <div id="lastname-error" class="error-message">
                                    <ValidationMessage For="@(() => registerModel.LastName)" />
                                </div>
                            </div>

                            <div>
                                <label for="firstname" class="block text-sm font-medium text-gray-700 mb-1">Prénom *</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-user text-gray-400"></i>
                                    </div>
                                    <InputText @bind-Value="registerModel.FirstName" type="text" id="firstname" name="firstname"
                                               class="pl-10 block w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-700 focus:border-transparent transition duration-200"
                                               placeholder="Votre prénom" />
                                </div>
                                <div id="firstname-error" class="error-message">
                                    <ValidationMessage For="@(() => registerModel.FirstName)" />
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Téléphone</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-phone text-gray-400"></i>
                                </div>
                                <InputText @bind-Value="registerModel.Tel" type="tel" id="phone" name="phone"
                                           class="pl-10 block w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-700 focus:border-transparent transition duration-200"
                                           placeholder="06 12 34 56 78" />
                            </div>
                            <div id="phone-error" class="error-message">
                                <ValidationMessage For="@(() => registerModel.Tel)" />
                            </div>
                        </div>

                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Mot de passe *</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-lock text-gray-400"></i>
                                </div>
                                <InputText @bind-Value="registerModel.Password" type="@PasswordInputType" id="password" name="password"
                                           class="pl-10 block w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-700 focus:border-transparent transition duration-200"
                                           placeholder="••••••••" />
                                <button type="button" id="togglePassword" class="absolute inset-y-0 right-0 pr-3 flex items-center"
                                        @onclick="TogglePasswordVisibility">
                                    <i class="@TogglePasswordIcon text-gray-400 hover:text-gray-600"></i>
                                </button>
                            </div>
                            <div id="password-error" class="error-message">
                                <ValidationMessage For="@(() => registerModel.Password)" />
                            </div>
                        </div>

                        <div>
                            <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">Confirmer le mot de passe *</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-lock text-gray-400"></i>
                                </div>
                                <InputText @bind-Value="registerModel.ConfirmPasswords" type="@PasswordInputType2" id="confirm-password" name="confirm-password"
                                           class="pl-10 block w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-700 focus:border-transparent transition duration-200"
                                           placeholder="••••••••" />
                                <button type="button" id="togglePassword" class="absolute inset-y-0 right-0 pr-3 flex items-center"
                                        @onclick="TogglePasswordVisibility2">
                                    <i class="@TogglePasswordIcon2 text-gray-400 hover:text-gray-600"></i>
                                </button>
                            </div>
                            <div id="confirm-password-error" class="error-message">
                                <ValidationMessage For="@(() => registerModel.ConfirmPasswords)" />
                            </div>
                        </div>

                        <div class="flex items-center">
                            <input id="terms" name="terms" type="checkbox"
                                   class="h-4 w-4 text-primary-700 focus:ring-primary-700 border-gray-300 rounded">
                            <label for="terms" class="ml-2 block text-sm text-gray-700">
                                J'accepte les <a href="#" class="text-primary-700 hover:underline">conditions d'utilisation</a>
                            </label>
                        </div>
                        <div id="terms-error" class="error-message hidden">Vous devez accepter les conditions</div>

                        <div>
                            <div>
                                <button type="submit"
                                        class="w-full bg-primary-700 text-white py-3 px-4 rounded-lg font-medium hover:opacity-90 transition duration-200 flex items-center justify-center space-x-2">
                                    <span>S'inscrire</span>
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                </EditForm>
                <div class="mt-8 text-center">
                    <p class="text-gray-600">
                        Vous avez déjà un compte?
                        <NavLink href="/login" class="text-primary-700 font-medium hover:text-primary-700">Connectez-vous</NavLink>
                    </p>
                </div>

                <div class="mt-8 border-t border-gray-200 pt-6">
                    <p class="text-xs text-gray-500 text-center">
                        En créant un compte, vous acceptez notre
                        <a href="#" class="text-primary-700 hover:underline">Politique de confidentialité</a>.
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>
@* 
<div class="min-h-screen flex flex-col items-center justify-center bg-gradient-to-r from-primary-700/10 to-primary-700/5  py-24  md:pt-32 ">
    <div class="mb-8">
        <!-- Logo SVG ou image -->
        <svg class="mx-auto h-12 w-12 text-primary-500" fill="none" viewBox="0 0 48 48">
            <circle cx="24" cy="24" r="24" fill="currentColor" />
        </svg>
    </div>
    <div class="w-full max-w-md bg-white rounded-lg shadow-md p-8">
        <h2 class="text-2xl font-bold text-center mb-6">Créer un compte</h2>
        
        <div class="flex items-center my-6">
            <div class="flex-grow border-t"></div>
            <span class="mx-4 text-gray-400">Ou continuer avec</span>
            <div class="flex-grow border-t"></div>
        </div>
        <div class="flex space-x-4">
            <button class="flex-1 flex items-center justify-center border rounded py-2 hover:bg-gray-50">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" alt="Google" class="h-5 w-5 mr-2" />
                Google
            </button>
            <button class="flex-1 flex items-center justify-center border rounded py-2 hover:bg-gray-50">
                <img src="https://www.svgrepo.com/show/512317/github-142.svg" alt="GitHub" class="h-5 w-5 mr-2" />
                GitHub
            </button>
        </div>
    </div>
    <div class="mt-6 text-gray-500">
        Déjà un membre?
        <a href="/login" class="text-primary-700 font-semibold hover:underline">Se connecter</a>
    </div>
</div>
 *@
@code {
    private string factor => FormFactor.GetFormFactor();
    private bool isLoad = false;
    private SignUpDTO registerModel = new();
    private ErrorMessage errorMessage = new();

    private EditContext? editContext;
    private ValidationMessageStore? messageStore;

    private bool showPassword = false;
    private bool showPassword2 = false;

    private string PasswordInputType => showPassword ? "text" : "password";
    private string TogglePasswordIcon => showPassword ? "fas fa-eye-slash" : "fas fa-eye";

    private string PasswordInputType2 => showPassword2 ? "text" : "password";
    private string TogglePasswordIcon2 => showPassword2 ? "fas fa-eye-slash" : "fas fa-eye";

    protected override void OnInitialized()
    {
        editContext = new EditContext(registerModel);
        messageStore = new ValidationMessageStore(editContext);

        editContext.OnValidationRequested += (s, e) => messageStore.Clear();
        editContext.OnFieldChanged += (s, e) => messageStore.Clear(e.FieldIdentifier);
    }

    private async Task HandleRegister()
    {
        isLoad = true;
        try
        {
            var response = await _authService.SignUp(new SignUpRequest(registerModel));
            if (response.Result)
            {
                NavManager.NavigateTo("signupsuccess");
            }
        }
        catch (ApiException ex)
        {
            try
            {
                var errorResult = JsonSerializer.Deserialize<ErrorMessage>(ex.Content, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                });

                // Efface les anciennes erreurs
                messageStore.Clear();

                if (errorResult?.ValidationErrors != null && errorResult.ValidationErrors.Any())
                {
                    foreach (var validationError in errorResult.ValidationErrors)
                    {
                        // Nettoyer le nom de propriété (ex: Product.Name -> Name)
                        var propertyName = validationError.PropertyName;
                        if (propertyName.Contains('.'))
                            propertyName = propertyName.Split('.').Last();

                        // Associer au champ si possible
                        var fieldIdentifier = new FieldIdentifier(registerModel!, propertyName);
                        messageStore.Add(fieldIdentifier, validationError.ErrorMessage);
                    }
                }
                else if (!string.IsNullOrWhiteSpace(errorResult?.Detail))
                {
                    // Message global sans champ spécifique
                    var fieldIdentifier = new FieldIdentifier(registerModel!, string.Empty);
                    messageStore.Add(fieldIdentifier, errorResult.Detail);
                }

                // Rafraîchir l’affichage
                editContext.NotifyValidationStateChanged();

            }
            catch
            {
                messageStore.Add(new FieldIdentifier(registerModel, string.Empty), "Une erreur est survenue.");
                editContext.NotifyValidationStateChanged();
            }
        }
        finally
        {
            isLoad = false;
            StateHasChanged();
        }
    }

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }
    private void TogglePasswordVisibility2()
    {
        showPassword2 = !showPassword2;
    }
}