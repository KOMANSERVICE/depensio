@page "/register"
@inherits FlowbitePage
@inject NavigationManager NavManager
@inject IAuthHttpService _authService;
@layout SecondaryLayout

<LoadingComponent IsLoad="@isLoad" />

<div class="min-h-screen flex flex-col items-center justify-center bg-gray-50  pt-24 md:pt-32 ">
    <div class="mb-8">
        <!-- Logo SVG ou image -->
        <svg class="mx-auto h-12 w-12 text-primary-500" fill="none" viewBox="0 0 48 48">
            <circle cx="24" cy="24" r="24" fill="currentColor" />
        </svg>
    </div>
    <div class="w-full max-w-md bg-white rounded-lg shadow-md p-8">
        <h2 class="text-2xl font-bold text-center mb-6">Sign in to your account</h2>
        <EditForm EditContext="@editContext" OnValidSubmit="HandleRegister">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="mb-4">
                <label class="block text-gray-700 mb-1" for="email">Email address</label>
                <InputText @bind-Value="registerModel.Email" id="email" type="email" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-primary-500" />
                <ValidationMessage For="@(() => registerModel.Email)" />
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-1" for="lastname">Nom</label>
                <InputText @bind-Value="registerModel.LastName" id="lastName" type="text" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-primary-500" />
                <ValidationMessage For="@(() => registerModel.LastName)" />
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-1" for="fistName">Prénom</label>
                <InputText @bind-Value="registerModel.FirstName" id="firstName" type="text" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-primary-500" />
                <ValidationMessage For="@(() => registerModel.FirstName)" />
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-1" for="tel">Téléphone</label>
                <InputText @bind-Value="registerModel.Tel" id="tel" type="text" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-primary-500" />
                <ValidationMessage For="@(() => registerModel.Tel)" />
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-1" for="password">Password</label>
                <InputText @bind-Value="registerModel.Password" id="password" type="password" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-primary-500" />
                <ValidationMessage For="@(() => registerModel.Password)" />
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-1" for="confirmPasswords">Password confirme</label>
                <InputText @bind-Value="registerModel.ConfirmPasswords" id="confirmPasswords" type="password" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-primary-500" />
                <ValidationMessage For="@(() => registerModel.ConfirmPasswords)" />
            </div>
            <div class="flex items-center justify-between mb-6">
                <label class="flex items-center">
                    <input type="checkbox" class="form-checkbox" />
                    <span class="ml-2 text-gray-600">Remember me</span>
                </label>
                <a href="#" class="text-primary-700 hover:underline text-sm">Forgot password?</a>
                <a href="#" class="text-primary-700 hover:underline text-sm">Forgot password?</a>
            </div>
            <button type="submit" class="w-full bg-primary-700 text-white py-2 rounded font-semibold hover:bg-primary-800 transition">Sign in</button>
        </EditForm>
        <div class="flex items-center my-6">
            <div class="flex-grow border-t"></div>
            <span class="mx-4 text-gray-400">Or continue with</span>
            <div class="flex-grow border-t"></div>
        </div>
        <div class="flex space-x-4">
            <button class="flex-1 flex items-center justify-center border rounded py-2 hover:bg-gray-50">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" alt="Google" class="h-5 w-5 mr-2" />
                Google
            </button>
            <button class="flex-1 flex items-center justify-center border rounded py-2 hover:bg-gray-50">
                <img src="https://www.svgrepo.com/show/512317/github-142.svg" alt="GitHub" class="h-5 w-5 mr-2" />
                GitHub
            </button>
        </div>
    </div>
    <div class="mt-6 text-gray-500">
        Not a member?
        <a href="#" class="text-primary-700 font-semibold hover:underline">Start a 14 day free trial</a>
    </div>
</div>

@code {
    private bool isLoad = false;
    private SignUpDTO registerModel = new();
    private ErrorMessage errorMessage = new();

    private EditContext editContext;
    private ValidationMessageStore messageStore;

    protected override void OnInitialized()
    {
        editContext = new EditContext(registerModel);
        messageStore = new ValidationMessageStore(editContext);

        editContext.OnValidationRequested += (s, e) => messageStore.Clear();
        editContext.OnFieldChanged += (s, e) => messageStore.Clear(e.FieldIdentifier);
    }

    private async Task HandleRegister()
    {
        isLoad = true;
        try
        {
            var response = await _authService.SignUp(new SignUpRequest(registerModel));
            if (response.Result)
            {
                NavManager.NavigateTo("signupsuccess");
            }
        }
        catch (ApiException ex)
        {
            try
            {
                var errorResult = JsonSerializer.Deserialize<ErrorMessage>(ex.Content, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                });

                foreach (var validationErrors in errorResult?.ValidationErrors ?? Enumerable.Empty<ValidationError>())
                {
                    messageStore.Add(new FieldIdentifier(registerModel, validationErrors.PropertyName.GetFieldName()), validationErrors.ErrorMessage);
                    editContext.NotifyValidationStateChanged();
                }

                
            }
            catch
            {
                messageStore.Add(new FieldIdentifier(registerModel, string.Empty), "Une erreur est survenue.");
                editContext.NotifyValidationStateChanged();
            }
        }
        finally
        {
            isLoad = false;
        }
    }

}