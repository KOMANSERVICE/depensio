@page "/login"
@inherits FlowbitePage
@inject NavigationManager NavManager
@inject IAuthService _authService
@inject IFormFactor FormFactor
@layout NoContentLayout

<PageTitleComponent Title="Connexion" />

<LoadingComponent IsLoad="@isLoad" />
<section class="bg-gradient-to-r from-primary-700/10 to-primary-700/5 min-h-screen">
    <div class="min-h-screen flex flex-col lg:flex-row">
        <!-- Section gauche (illustration) -->
        <div class="lg:w-1/2 bg-primary-700 flex items-center justify-center p-12 text-white">
            <div class="max-w-md text-center">
                <div class="text-5xl mb-6">
                    <i class="fas fa-store"></i>
                </div>
                <h1 class="text-4xl font-bold mb-4">Depensio</h1>
                <p class="text-xl opacity-90 mb-8">Pilotez toutes vos entreprises en ligne depuis une seule interface</p>
                <div class="flex justify-center space-x-4 mb-8">
                    <div class="w-12 h-12 rounded-full bg-white bg-opacity-20 flex items-center justify-center">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-white bg-opacity-20 flex items-center justify-center">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-white bg-opacity-20 flex items-center justify-center">
                        <i class="fas fa-users-cog"></i>
                    </div>
                </div>
                @if (factor.Contains("web", StringComparison.OrdinalIgnoreCase))
                {
                    <div class="flex justify-center items-center mb-8">
                        <svg class="w-6 h-6 text-white dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12l4-4m-4 4 4 4" />
                        </svg>
                        <NavLink href="/" class="text-xl opacity-90">
                            Retour à l'accueil
                        </NavLink>
                    </div>
                }

            </div>
        </div>

        <!-- Section droite (formulaire) -->
        <div class="lg:w-1/2 flex items-center justify-center p-12">
            <div class="w-full max-w-md">
                <div class="text-center mb-10">
                    <h2 class="text-3xl font-bold text-gray-800">Connectez-vous</h2>
                    <p class="text-gray-600 mt-2">Accédez à votre tableau de bord</p>
                </div>
                <EditForm EditContext="@editContext" OnValidSubmit="HandleLogin" class="space-y-6">
                    <DataAnnotationsValidator />
                    <ErrorsSummary editContext="@editContext" />
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Adresse email</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-envelope text-gray-400"></i>
                            </div>
                            <InputText @bind-Value="loginModel.Email" type="email" id="email" name="email"
                                       class="pl-10 input-focus block w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-700 focus:border-transparent transition duration-200"
                                       placeholder="votre@email.com" />
                        </div>
                        <div id="email-error" class="error-message">
                            <ValidationMessage For="@(() => loginModel.Email)" />
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="password" class="block text-sm font-medium text-gray-700">Mot de passe</label>
                            <NavLink href="/forgot-password" class="text-sm text-primary-700 hover:text-primary-700">Mot de passe oublié?</NavLink>
                        </div>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-lock text-gray-400"></i>
                            </div>
                            <InputText @bind-Value="loginModel.Password" type="@PasswordInputType" id="password" name="password"
                                       class="pl-10 input-focus block w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-700 focus:border-transparent transition duration-200"
                                       placeholder="••••••••" />
                            <button type="button" id="togglePassword" class="absolute inset-y-0 right-0 pr-3 flex items-center"
                                    @onclick="TogglePasswordVisibility">
                                <i class="@TogglePasswordIcon text-gray-400 hover:text-gray-600"></i>
                            </button>
                        </div>
                        <div id="email-error" class="error-message">
                            <ValidationMessage For="@(() => loginModel.Password)" />
                        </div>
                    </div>

                    <div class="flex items-center">
                        <input id="remember-me" name="remember-me" type="checkbox"
                               class="h-4 w-4 text-primary-700 focus:ring-primary-700 border-gray-300 rounded">
                        <label for="remember-me" class="ml-2 block text-sm text-gray-700">
                            Se souvenir de moi
                        </label>
                    </div>

                    <div>
                        <button type="submit"
                                class="w-full bg-primary-700 text-white py-3 px-4 rounded-lg font-medium hover:opacity-90 transition duration-200 flex items-center justify-center space-x-2">
                            <span>Connexion</span>
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </EditForm>

                <div class="mt-8 text-center">
                    <p class="text-gray-600">
                        Nouveau sur la plateforme?
                        <a href="/register" class="text-primary-700 font-medium hover:text-primary-700">Créer un compte</a>
                    </p>
                </div>

                <div class="mt-8 border-t border-gray-200 pt-6">
                    <p class="text-xs text-gray-500 text-center">
                        En vous connectant, vous acceptez nos
                        <a href="#" class="text-primary-700 hover:underline">Conditions d'utilisation</a>
                        et notre
                        <a href="#" class="text-primary-700 hover:underline">Politique de confidentialité</a>.
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>

@code {
    private string factor => FormFactor.GetFormFactor();
    private bool isLoad = false;
    private SignInDTO loginModel = new();
    private ErrorMessage errorMessage = new();

    private EditContext editContext;
    private ValidationMessageStore messageStore;

    private bool showPassword = false;

    private string PasswordInputType => showPassword ? "text" : "password";
    private string TogglePasswordIcon => showPassword ? "fas fa-eye-slash" : "fas fa-eye";

    protected override void OnInitialized()
    {
        editContext = new EditContext(loginModel);
        messageStore = new ValidationMessageStore(editContext);

        editContext.OnValidationRequested += (s, e) => messageStore.Clear();
        editContext.OnFieldChanged += (s, e) => messageStore.Clear(e.FieldIdentifier);
    }

    private async Task HandleLogin()
    {
        isLoad = true;
        try
        {
            var isConnected = await _authService.SignInAsync(new SignInRequest(loginModel));
            if (isConnected)
            {
                NavManager.NavigateTo("/listboutique");
            }
        }
        catch (ApiException ex)
        {
            try
            {
                var errorResult = JsonSerializer.Deserialize<ErrorMessage>(ex.Content, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                });

                // Efface les anciennes erreurs
                messageStore.Clear();

                if (errorResult?.ValidationErrors != null && errorResult.ValidationErrors.Any())
                {
                    foreach (var validationError in errorResult.ValidationErrors)
                    {
                        // Nettoyer le nom de propriété (ex: Product.Name -> Name)
                        var propertyName = validationError.PropertyName;
                        if (propertyName.Contains('.'))
                            propertyName = propertyName.Split('.').Last();

                        // Associer au champ si possible
                        var fieldIdentifier = new FieldIdentifier(loginModel!, propertyName);
                        messageStore.Add(fieldIdentifier, validationError.ErrorMessage);
                    }
                }
                else if (!string.IsNullOrWhiteSpace(errorResult?.Detail))
                {
                    // Message global sans champ spécifique
                    var fieldIdentifier = new FieldIdentifier(loginModel!, string.Empty);
                    messageStore.Add(fieldIdentifier, errorResult.Detail);
                }

                // Rafraîchir l’affichage
                editContext.NotifyValidationStateChanged();

            }
            catch
            {
                messageStore.Add(new FieldIdentifier(loginModel, string.Empty), "Une erreur est survenue.");
                editContext.NotifyValidationStateChanged();
            }
        }
        finally
        {
            isLoad = false;
            StateHasChanged();
        }
    }

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }
}
