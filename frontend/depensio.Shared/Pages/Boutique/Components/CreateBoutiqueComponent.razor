@using depensio.Shared.Pages.Boutique.Model
@inject IBoutiqueService _boutiqueService

<LoadingComponent IsLoad="@isLoad" />

<EditForm EditContext="@editContext" OnValidSubmit="HandleCreateBoutique">
    <DataAnnotationsValidator />
    <ValidationSummaryFancy editContext="@editContext" />

    <div class="p-6">
        <div class="mb-4">
            <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Nom de l'entreprise</label>
            <InputText type="text" @bind-Value="boutique.Name" id="name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-700 focus:border-primary-700" />

            <div id="email-error" class="error-message">
                <ValidationMessage For="@(() => boutique.Name)" />
            </div>
        </div>
        <div class="mb-4">
            <label for="location" class="block text-sm font-medium text-gray-700 mb-1">Localité / Adresse</label>
            <InputText type="text" @bind-Value="boutique.Location" id="location" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-700 focus:border-primary-700" />
            <div id="email-error" class="error-message">
                <ValidationMessage For="@(() => boutique.Location)" />
            </div>
        </div>
        <div class="mb-4">
            <label for="businessType" class="block text-sm font-medium text-gray-700 mb-1">Type d'activité</label>
            <select id="businessType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-700 focus:border-primary-700">
                <option value="">Sélectionnez un type</option>
                <option value="restaurant">Restaurant</option>
                <option value="retail">Commerce de détail</option>
                <option value="services">Services</option>
                <option value="tech">Technologie</option>
                <option value="other">Autre</option>
            </select>
        </div>
        <div class="mb-6">
            <label for="businessDescription" class="block text-sm font-medium text-gray-700 mb-1">Description (optionnel)</label>
            <textarea id="businessDescription" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-700 focus:border-primary-700"></textarea>
        </div>
    </div>


    <div class="flex justify-end gap-3 px-6 py-4 border-t">
        <button type="button" @onclick="cancelSave" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Annuler</button>
        <button type="submit" class="px-4 py-2 bg-primary-700 hover:bg-amber-800 text-white rounded-lg">Créer l'entreprise</button>
    </div>
</EditForm>
@*         </div>
    </div>
</div> *@

@code {
    [Parameter]
    public EventCallback<MouseEventArgs> OnAfterSave { get; set; }
    [Parameter]
    public EventCallback<MouseEventArgs> OnCancelSave { get; set; }

    [Parameter]
    public bool ShowModal { get; set; } = false;


    private bool isLoad = false;
    private BoutiqueDTO boutique = new();
    private ErrorMessage errorMessage = new();

    private EditContext editContext;
    private ValidationMessageStore messageStore;

    protected override void OnInitialized()
    {
        editContext = new EditContext(boutique);
        messageStore = new ValidationMessageStore(editContext);

        editContext.OnValidationRequested += (s, e) => messageStore.Clear();
        editContext.OnFieldChanged += (s, e) => messageStore.Clear(e.FieldIdentifier);
    }

    private void cancelSave()
    {
        OnCancelSave.InvokeAsync(null);
    }

    private async Task HandleCreateBoutique()
    {
        isLoad = true;
        try
        {
            var result = await _boutiqueService.CreateBoutique(new CreateBoutiqueRequest(boutique));
            if (result.Success)
            {
                messageStore.Clear();
                editContext.NotifyValidationStateChanged();
                boutique = new BoutiqueDTO(); // Reset the boutique object
                await OnAfterSave.InvokeAsync(null); // Notify parent component
            }

        }

        catch (ApiException ex)
        {
            try
            {
                var errorResult = JsonSerializer.Deserialize<ErrorMessage>(ex.Content, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                });


                // Efface les anciennes erreurs
                messageStore.Clear();

                if (errorResult?.ValidationErrors != null && errorResult.ValidationErrors.Any())
                {
                    foreach (var validationError in errorResult.ValidationErrors)
                    {
                        // Nettoyer le nom de propriété (ex: Product.Name -> Name)
                        var propertyName = validationError.PropertyName;
                        if (propertyName.Contains('.'))
                            propertyName = propertyName.Split('.').Last();

                        // Associer au champ si possible
                        var fieldIdentifier = new FieldIdentifier(boutique!, propertyName);
                        messageStore.Add(fieldIdentifier, validationError.ErrorMessage);
                    }
                }
                else if (!string.IsNullOrWhiteSpace(errorResult?.Detail))
                {
                    // Message global sans champ spécifique
                    var fieldIdentifier = new FieldIdentifier(boutique!, string.Empty);
                    messageStore.Add(fieldIdentifier, errorResult.Detail);
                }

                // Rafraîchir l’affichage
                editContext.NotifyValidationStateChanged();


            }
            catch
            {
                messageStore?.Add(new FieldIdentifier(boutique, string.Empty), "Une erreur est survenue.");
                editContext?.NotifyValidationStateChanged();
            }
        }
        finally
        {
            isLoad = false;
            StateHasChanged();
        }
    }

    private string onShowModal(bool show) =>
    show
        ? "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
        : "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden";


}
