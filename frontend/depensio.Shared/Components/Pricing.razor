@inject IJSRuntime JS

@functions {
    private string FormatMoney(decimal value)
    {
        return string.Format(System.Globalization.CultureInfo.GetCultureInfo("fr-FR"), "{0:N0}", value).Replace(",", " ");
    }
}

<div class="py-20 bg-gray-50" id="pricing">
    <div class="container mx-auto px-6">
        <div class="max-w-7xl mx-auto text-center">
            <h3 class="text-2xl sm:text-3xl lg:text-4xl font-medium text-black-600 leading-relaxed mb-4">
                Des tarifs adaptés à vos besoins
            </h3>
            <div class="w-20 h-1 bg-primary-700 mx-auto mb-6"></div>
            <p class="leading-normal w-10/12 sm:w-7/12 lg:w-6/12 mx-auto my-2 text-center">
                Choisissez le plan qui correspond à vos besoins. Tous nos plans incluent un essai gratuit de 3 mois.
            </p>
            <div class="inline-flex items-center mb-10 space-x-2 bg-gray-100 rounded-full p-1">
                <button @onclick="() => SetBillingCycle(BillingCycle.Monthly)"
                        class="@GetToggleButtonClass(BillingCycle.Monthly)">
                    Mensuel
                </button>
                <button @onclick="() => SetBillingCycle(BillingCycle.Annually)"
                        class="@GetToggleButtonClass(BillingCycle.Annually)">
                    Annuel
                </button>
            </div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
            @foreach (var plan in Plans)
            {
                <div class="@GetCardClasses(plan)">
                    <div class="flex justify-between items-start">
                        <h3 class="text-lg font-semibold text-gray-900">@plan.Title</h3>
                        @if (plan.IsPopular)
                        {
                            <span class="text-xs text-primary-800 bg-primary-300 px-2 py-0.5 rounded-full font-medium">Recommandé</span>
                        }
                    </div>
                    <p class="text-sm text-gray-500 mb-4" style="min-height:2.5em;line-height:1.25em;">@(string.IsNullOrWhiteSpace(plan.Description) ? "\u00A0" : plan.Description.Replace("nécéssite un paiement supplementaire", "nécessite un paiement supplémentaire"))</p>
                    @if (plan.IsDiscount)
                    {
                        <div class="mb-2">
                            <span class="text-xs font-bold text-red-600 bg-red-100 px-2 py-1 rounded">Promotion -@((int)((decimal)plan.DiscountRate*100))%</span>
                        </div>
                        <div class="flex flex-col items-end mb-1">
                            <span class="line-through text-gray-400 text-xl">@FormatMoney(Billing == BillingCycle.Monthly ? plan.Price : plan.Price * 12) FCFA</span>
                            <span class="text-2xl font-bold text-gray-900">@FormatMoney(Billing == BillingCycle.Monthly ? plan.Price * (1 - (decimal)plan.DiscountRate) : (plan.Price * 12) * (1 - (decimal)plan.DiscountRate)) FCFA @GetBillingText()</span>
                        </div>
                    }
                    else
                    {
                        <div class="flex flex-col items-end mb-1">
                            <span class="text-2xl font-bold text-gray-900">@FormatMoney(Billing == BillingCycle.Monthly ? plan.Price : plan.Price * 12) FCFA @GetBillingText()</span>
                        </div>
                    }
                    <NavLink href="/register" class="@GetButtonClasses(plan)">Choisir ce plan</NavLink>
                    <ul class="mt-6 space-y-2 text-sm text-gray-700">
                        @foreach (var feature in plan.Features)
                        {
                            <li class="flex items-start space-x-2">
                                <span class="mt-0.5">
                                    <svg class="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                                </span>
                                <span>@feature.Replace("nécéssite un paiement supplementaire", "nécessite un paiement supplémentaire")</span>
                            </li>
                        }
                    </ul>
                </div>
            }
        </div>
        <!-- Tableau de comparaison dynamique -->
        <div class="overflow-x-auto rounded-lg w-full mx-auto text-center py-8">
            <div class="inline-block w-full align-middle">
                <div class="shadow sm:rounded-lg">
                    <table class="w-full">
                        <thead class="bg-gray-50 dark:bg-gray-900">
                            <tr>
                                <th scope="col" class="p-4 text-left font-medium text-gray-700"></th>
                                @foreach (var plan in Plans)
                                {
                                    <th scope="col" class="p-4 text-base font-semibold tracking-wider text-right text-gray-900 dark:text-white">@plan.Title</th>
                                }
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-800">
                            @foreach (var feature in ComparisonFeatures)
                            {
                                <tr class="border-b last:border-b-0 odd:bg-white even:bg-gray-50 dark:odd:bg-gray-800 dark:even:bg-gray-900">
                                    <td class="p-4 text-base font-normal text-gray-500 rounded-l-lg whitespace-nowrap dark:text-gray-400 text-left">@feature.Label.Replace("nécéssite un paiement supplementaire", "nécessite un paiement supplémentaire")</td>
                                    @foreach (var plan in Plans)
                                    {
                                        <td class="p-4 text-right align-middle ">
                                            @if (feature.Type == "value")
                                            {
                                                var value = plan.Features.FirstOrDefault(f => f.ToLower().Contains(feature.Match));
                                                if (!string.IsNullOrEmpty(value))
                                                {
                                                    if (feature.Label.Contains("utilisateur"))
                                                    {
                                                        if (value.ToLower().Contains("illimit"))
                                                        {
                                                            <span class="inline-flex items-center font-semibold text-gray-900 dark:text-white text-right">
                                                                <svg class="flex-shrink-0 w-5 h-5 mr-1 text-gray-900 dark:text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"></path></svg>
                                                                Illimité
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="inline-flex items-center font-semibold text-gray-900 dark:text-white text-right">
                                                                <svg class="flex-shrink-0 w-5 h-5 mr-1 text-gray-900 dark:text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
                                                                @value
                                                            </span>
                                                        }
                                                    }
                                                    else if (feature.Label.Contains("produit"))
                                                    {
                                                        if (value.ToLower().Contains("illimit"))
                                                        {
                                                            <span class="font-semibold text-gray-900 dark:text-white text-right">Produit illimité</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="font-semibold text-gray-900 dark:text-white text-right">@value</span>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <span class="font-semibold text-gray-900 dark:text-white text-right">@value</span>
                                                    }
                                                }
                                            }
                                            else if (feature.Type == "bool")
                                            {
                                                var hasFeature = plan.Features.Any(f => f.Contains(feature.Match));
                                                if (hasFeature)
                                                {
                                                    <svg class="w-5 h-5 text-green-400 ml-auto" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                                                }
                                                else
                                                {
                                                    <svg class="w-5 h-5 text-red-500 ml-auto" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                                                }
                                            }
                                        </td>
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private enum BillingCycle
    {
        Monthly,
        Annually
    }

    private BillingCycle Billing = BillingCycle.Monthly;

    public class Plan
    {
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
        public decimal Price { get; set; }
        public bool IsPopular { get; set; } = false;
        public List<string> Features { get; set; } = new();
        public double DiscountRate { get; set; } = 0.5;
        public bool IsDiscount { get; set; } = true;
    }

    private List<Plan> Plans = new()
    {
        new Plan
        {
            Title = "Gratuit",
            Description = "Idéal pour débuter et gérer un petit stock.",
            Price = 0,
            DiscountRate = 0,
            IsDiscount = false,
            Features = new() { "20 produits", "1 utilisateur", "Achat de produit", "Vente de produit", "Impression de code barre" }
        },
        new Plan
        {
            Title = "Débutant",
            Description = "Pour les petites entreprises avec plus de produits.",
            Price = 10000,
            DiscountRate = 0.5,
            IsDiscount = true,
            Features = new() { "100 produits", "1 utilisateur", "Achat de produit", "Vente de produit", "Impression de code barre", "Inventaire", "Gestion du stock" }
        },
        new Plan
        {
            Title = "Standard",
            Description = "Pour les entreprises en croissance.",
            Price = 20000,
            DiscountRate = 0.5,
            IsPopular = true,
            IsDiscount = true,
            Features = new() { "200 produits", "20 utilisateurs", "Achat de produit", "Vente de produit", "Impression de code barre", "Inventaire", "Gestion du stock", "Boutique en ligne" }
        },
        new Plan
        {
            Title = "Professionnel",
            Description = "Tout illimité, vente en ligne et boutique en ligne. Fonctionnalités avancées disponibles.",
            Price = 50000,
            DiscountRate = 0.7,
            IsDiscount = true,
            Features = new() { "Produits illimités", "Utilisateurs illimités", "Achat de produit","Vente de produit", "Impression de code barre", "Inventaire", "Gestion du stock", "Boutique en ligne", "Gestion de plusieurs magasins (option nécessite un paiement supplémentaire)", "Personnalisation des rapports (option nécessite un paiement supplémentaire)" }
        }
    };

    private List<(string Label, string Match, string Type)> ComparisonFeatures = new()
    {
        ("Nombre de produits", "produit", "value"),
        ("Nombre d'utilisateurs", "utilisateur", "value"),
        ("Achat de produit", "Achat de produit", "bool"),
        ("Vente de produit", "Vente de produit", "bool"),
        ("Impression de code barre", "Impression de code barre", "bool"),
        ("Inventaire", "Inventaire", "bool"),
        ("Gestion du stock", "Gestion du stock", "bool"),
        ("Boutique en ligne", "Boutique en ligne", "bool"),
        ("Gestion de plusieurs magasins (option nécessite un paiement supplémentaire)", "Gestion de plusieurs magasins", "bool"),
        ("Personnalisation des rapports (option nécessite un paiement supplémentaire)", "Personnalisation des rapports", "bool")
    };

    private string GetCardClasses(Plan plan) =>
        plan.IsPopular
            ? "border-2 border-primary-700 rounded-xl p-6 shadow-lg bg-white price-card"
            : "border border-gray-200 rounded-xl p-6 bg-white price-card";

    private string GetButtonClasses(Plan plan) =>
        plan.IsPopular
            ? "mt-4 block w-full text-white bg-primary-700 hover:bg-primary-800 font-semibold py-2 rounded-md text-center"
            : "mt-4 block w-full text-primary-700 hover:bg-primary-800 hover:text-white font-semibold py-2 border border-primary-700 rounded-md text-center";

    private void SetBillingCycle(BillingCycle cycle)
    {
        Billing = cycle;
    }

    private string GetToggleButtonClass(BillingCycle cycle) =>
       Billing == cycle
           ? "px-4 py-1 text-sm font-medium text-white bg-primary-700 rounded-full"
           : "px-4 py-1 text-sm font-medium text-gray-700 rounded-full";

    private string GetBillingText() =>
        Billing == BillingCycle.Monthly ? "/mois" : "/an";
}
