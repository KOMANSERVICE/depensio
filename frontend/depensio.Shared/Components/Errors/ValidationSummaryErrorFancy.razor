@using Microsoft.AspNetCore.Components.Forms
@implements IDisposable

@if (validationMessages.Any())
{
    <div id="errorSummary" class="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
        <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                 stroke-linejoin="round"
                 class="feather feather-alert-circle text-red-500 mr-2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <h3 class="text-red-800 font-medium">Veuillez corriger les erreurs suivantes :</h3>
        </div>
        <ul id="errorList" class="list-disc pl-5 mt-2 text-red-700 space-y-1">
            @foreach (var message in validationMessages)
            {
                <li>@message</li>
            }
        </ul>
    </div>
}

@code {
    [CascadingParameter] private EditContext CurrentEditContext { get; set; } = default!;

    private readonly List<string> validationMessages = new();

    protected override void OnInitialized()
    {
        if (CurrentEditContext == null)
        {
            throw new InvalidOperationException($"{nameof(ValidationSummaryFancy)} doit être utilisé dans un <EditForm>.");
        }

        CurrentEditContext.OnValidationStateChanged += ValidationStateChanged;
    }

    private void ValidationStateChanged(object? sender, ValidationStateChangedEventArgs e)
    {
        validationMessages.Clear();

        StateHasChanged();

        var messages = CurrentEditContext.GetValidationMessages();
        validationMessages.AddRange(messages);

        StateHasChanged();
    }

    public void Dispose()
    {
        if (CurrentEditContext != null)
        {
            CurrentEditContext.OnValidationStateChanged -= ValidationStateChanged;
        }
    }
}
